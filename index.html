<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
        }
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 20px;
            width: 200px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }

        .member-card img {
            width: 360px; /* 이미지 크기 2배 추가 확대 */
            height: 360px; /* 이미지 크기 2배 추가 확대 */
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 4px solid #ad1457;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s;
        }
        .member-card.selected img {
             border-color: #ff5252;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #startGameButton {
            background-color: #4CAF50;
            color: white;
            position: absolute; /* 하단 가운데 배치 */
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
        }
        #startGameButton:hover {
            background-color: #43A047;
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            display: none;
            margin-top: 20px; /* 시작 버튼과 간격 */
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            width: 200px;
            box-sizing: border-box;
            position: relative;
        }
        .top-member-card.rank1 { border: 4px solid #FFD700; background-color: #FFFACD; }
        .top-member-card.rank2 { border: 4px solid #C0C0C0; background-color: #E0E0E0; }
        .top-member-card.rank3 { border: 4px solid #CD7F32; background-color: #D2B48C; }

        .top-member-card img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid #ad1457;
        }
        .top-member-card p {
            font-size: 1.4em;
            font-weight: bold;
            color: #ad1457;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            .member-display {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .member-card {
                width: 90%;
                max-width: 250px;
            }
            .member-card img {
                width: 150px;
                height: 150px;
            }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 90%;
            }
            .top-members {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%;
            }
            #startGameButton {
                position: static;
                transform: none;
                width: 90%;
                margin: 20px auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>
        <p>당신의 선택으로 HKT48 <b>16인 선발 멤버</b>를 뽑아주세요!</p>
        <p style="font-weight: bold; color: #ad1457;">⭐ 멤버를 클릭하는 순서대로 1, 2위가 결정됩니다. (3위는 자동 선택)</p>

        <div id="gameScreen">
            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2>오늘의 멤버를 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
                </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <button id="startGameButton">게임 시작</button>

        <div id="resultsScreen" class="results-screen">
            <h2>🎉 16인 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
                </div>
            <div class="final-selection-list">
                <h3>💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                    </ul>
            </div>
            <div class="restart-button-group">
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이시하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우네 네네", "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        const memberData = {};
        memberNames.forEach(name => {
            memberData.name = { score: 0, appearances: 0, thirdPlaceCount: 0, eliminated: false };
        });

        let currentRound = 0;
        const membersPerRound = 3;
        let selectionOrder = [];
        let playedCombinations = new Set();
        let roundTimeout;

        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const currentRoundSpan = document.getElementById('currentRound');
        const memberSelectionDiv = document.getElementById('memberSelection');
        const startGameButton = document.getElementById('startGameButton');
        const resetGameButton = document.getElementById('resetGameButton');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const restartGameButton = document.getElementById('restartGameButton');

        startGameButton.addEventListener('click', initializeGame);
        resetGameButton.addEventListener('click', initializeGame);
        restartGameButton.addEventListener('click', initializeGame);

        function initializeGame() {
            for (const name of memberNames) {
                memberData.name = { score: 0, appearances: 0, thirdPlaceCount: 0, eliminated: false };
            }
            currentRound = 0;
            playedCombinations = new Set();
            clearTimeout(roundTimeout);

            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            startGameButton.style.display = 'none';
            resetGameButton.style.display = 'block';

            startNextRound();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                (arrayi, arrayj) = (arrayj, arrayi);
            }
            return array;
        }

        function getCandidateMembersForRound() {
            return memberNames.filter(name => memberData.name.appearances < 3 && !memberData.name.eliminated);
        }

        function getUniqueRoundMembers() {
            const candidates = getCandidateMembersForRound();
            if (candidates.length < membersPerRound) {
                const fallbackCandidates = memberNames.filter(name => !memberData.name.eliminated)
                    .sort((a, b) => memberData.a.appearances - memberData.b.appearances);
                console.warn("경고: 남은 멤버 부족으로 등장 횟수 제한 완화.");
                return shuffleArray(fallbackCandidates).slice(0, membersPerRound);
            }

            let roundMembers = [];
            let attempts = 0;
            const maxAttempts = 5000;

            while (roundMembers.length < membersPerRound && attempts < maxAttempts) {
                const potentialRound = shuffleArray([...candidates]).slice(0, membersPerRound).sort();
                const combinationKey = potentialRound.join('-');
                if (!playedCombinations.has(combinationKey)) {
                    roundMembers = potentialRound;
                    playedCombinations.add(combinationKey);
                }
                attempts++;
            }

            if (roundMembers.length < membersPerRound) {
                console.warn("경고: 조합 규칙을 준수하며 멤버를 찾기 어려워 강제 선택.");
                const sortedCandidates = candidates.sort((a, b) => memberData.a.appearances - memberData.b.appearances);
                roundMembers = sortedCandidates.slice(0, membersPerRound);
                playedCombinations.add([...roundMembers].sort().join('-'));
            }
            return roundMembers;
        }

        function startNextRound() {
            currentRound++;
            currentRoundSpan.textContent = currentRound;
            selectionOrder = [];

            const activeMembers = memberNames.filter(name => !memberData.name.eliminated);
            if (activeMembers.length < 16 || currentRound > 60) {
                endGame();
                return;
            }

            const membersForThisRound = getUniqueRoundMembers();
            const shuffledMembersForDisplay = shuffleArray(membersForThisRound);

            memberSelectionDiv.innerHTML = '';
            shuffledMembersForDisplay.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <div class="selection-rank"></div>
                    <img src="./images/${name}.png" alt="${name}">
                    <p>${name}</p>
                `;
                card.addEventListener('click', () => handleCardClick(card, name));
                memberSelectionDiv.appendChild(card);

                memberData.name.appearances++;
            });
        }

        function handleCardClick(clickedCard, memberName) {
            const isAlreadySelected = selectionOrder.includes(memberName);

            if (isAlreadySelected) {
                if (selectionOrder.lastIndexOf(memberName) === selectionOrder.length - 1) {
                    clickedCard.classList.remove('selected');
                    clickedCard.querySelector('.selection-rank').textContent = '';
                    selectionOrder.pop();
                    updateSelectionRanks();
                } else {
                    alert("가장 마지막에 선택한 멤버부터 해제할 수 있습니다.");
                }
            } else {
                if (selectionOrder.length < 2) {
                    clickedCard.classList.add('selected');
                    selectionOrder.push(memberName);
                    clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length;
                } else if (selectionOrder.length === 2) {
                    clickedCard.classList.add('selected');
                    selectionOrder.push(memberName);
                    clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length;
                    setTimeout(applyScoresAndProceed, 800);
                } else {
                    alert("두 명의 멤버만 선택할 수 있습니다. 마지막 선택 멤버부터 해제하세요.");
                }
            }
        }

        function updateSelectionRanks() {
            document.querySelectorAll('.member-card.selected').forEach(card => {
                const memberName = card.dataset.name;
                const index = selectionOrder.indexOf(memberName);
                if (index !== -1) {
                    card.querySelector('.selection-rank').textContent = index + 1;
                }
            });
        }

        function applyScoresAndProceed() {
            document.querySelectorAll('.member-card').forEach(card => {
                card.removeEventListener('click', handleCardClick);
                card.style.cursor = 'default';
            });

            memberData.selectionOrder0.score += 2;
            memberData.selectionOrder1.score += 1;
            const thirdPlaceMember = memberSelectionDiv.querySelector(`.member-card:not(.selected)`);
            if (thirdPlaceMember) {
                const thirdPlaceName = thirdPlaceMember.dataset.name;
                memberData.thirdPlaceName.thirdPlaceCount++;
                if (memberData.thirdPlaceName.thirdPlaceCount >= 3) {
                    memberData.thirdPlaceName.eliminated = true;
                    console.log(`${thirdPlaceName} 멤버가 3위 3회로 탈락했습니다.`);
                }
            }

            selectionOrder.forEach((name, index) => {
                const card = memberSelectionDiv.querySelector(`(data-name="${name}"]`);
                if (card) {
                    card.classList.add('chosen'); // 선택 완료 스타일 (금은동 구분 없음)
                    card.classList.remove('selected');
                }
            });
            const thirdPlaceCard = memberSelectionDiv.querySelector(`.member-card:not(.chosen)`);
            if (thirdPlaceCard) {
                thirdPlaceCard.classList.add('chosen');
            }

            roundTimeout = setTimeout(startNextRound, 1500);
        }


        function endGame() {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            resetGameButton.style.display = 'none';

            const sortedMembers = Object.entries(memberData)
                .filter(([name, data]) => !data.eliminated)
                .sort(([, a], [, b]) => b.score - a.score);

            const finalTop16 = sortedMembers.slice(0, 16);
            const top3 = finalTop16.slice(0, 3);

            topMembersDisplay.innerHTML = '';
            top3.forEach((memberArray, index) => {
                const memberName = memberArray0;
                const data = memberArray1;

                const card = document.createElement('div');
                card.classList.add('top-member-card');
                if (index === 0) card.classList.add('rank1');
                else if (index === 1) card.classList.add('rank2');
                else if (index === 2) card.classList.add('rank3');

                card.innerHTML = `
                    <div class="rank-label">${index + 1}위</div>
                    <img src="./images/${memberName}.png" alt="${memberName}">
                    <p>${memberName}</p>
                    <span class="score">${data.score}점</span>
                `;
                topMembersDisplay.appendChild(card);
            });

            finalSelectionList.innerHTML = '';
            finalTop16.forEach(([name, data]) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${name} (${data.score}점)`;
                finalSelectionList.appendChild(listItem);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
            startGameButton.style.display = 'block';
            resetGameButton.style.display = 'none';
        });
    </script>
</body>
</html>
