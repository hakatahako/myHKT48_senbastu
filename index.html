<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        /* 바닥판 */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1160px; 
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 15px; 
            margin-top: 30px;
        }
        /* 멤버카드 (분홍색 판) - PC 기본 스타일 */
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 15px; /* PC 패딩 줄임 */
            width: 370px; 
            min-width: 370px; 
            flex-shrink: 0; 
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column; /* PC: 세로형 */
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        .member-card.processed {
            pointer-events: none;
            opacity: 0.8;
        }

        /* 멤버 사진 - PC 기본 스타일 */
        .member-card img {
            width: 350px; 
            height: 350px; 
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px; /* PC 이미지 아래 여백 줄임 */
            transition: border-color 0.2s;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            margin-top: 20px; /* PC에서는 기존 위치 유지 */
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center; 
            align-items: flex-end; 
            gap: 30px; /* 이미지 크기 증가에 맞춰 간격 조정 */
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 30px; /* 패딩 늘림 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        /* 1위 카드 스타일 (2,3위보다 10% 더 크게) */
        .top-member-card.rank1 {
            width: calc(247.5px + 60px + 8px); 
            height: auto; 
            border: 4px solid #FFD700; 
            background-color: #FFFACD;
            transform: translateY(-30px); 
            order: 2; 
        }
        .top-member-card.rank1 img {
            width: 247.5px; 
            height: 247.5px; 
        }

        /* 2, 3위 카드 스타일 (기준 크기) */
        .top-member-card.rank2, .top-member-card.rank3 {
            width: calc(225px + 60px + 8px); 
            height: auto; 
            border: 4px solid #C0C0C0; 
            background-color: #E0E0E0;
            order: 1; 
        }
        .top-member-card.rank3 {
            border: 4px solid #CD7F32; 
            background-color: #D2B48C;
            order: 3; 
        }
        .top-member-card.rank2 img, .top-member-card.rank3 img {
            width: 225px; 
            height: 225px; 
        }
        
        .top-member-card img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }
        .top-member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
            display: none; 
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 15px; 
        }
        .restart-button-group button {
            width: 250px; 
        }
        /* 동점자 라운드 시 표시될 안내 텍스트 스타일 */
        .tie-breaker-info {
            font-weight: bold;
            color: #ad1457;
            font-size: 1.1em;
            margin-bottom: 15px;
            animation: pulse 1.5s infinite alternate; /* 깜빡이는 효과 */
        }

        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                max-width: 95%; 
            }
            h1 {
                font-size: 1.8em;
            }
            /* 모바일에서 라운드 정보와 '오늘의 멤버' 문구 숨김 */
            .round-info, h2 {
                display: none;
            }
            /* 모바일 상단 안내 글자 간략화 및 크기 조정 */
            #instructionText {
                font-size: 0.9em; 
                margin-top: 0; 
                margin-bottom: 15px; 
            }
            .tie-breaker-info { /* 모바일에서 동점자 안내 텍스트 크기 조정 */
                font-size: 0.9em;
            }


            .member-display {
                flex-direction: column; 
                align-items: center;
                gap: 10px; 
                margin-top: 15px; 
            }
            /* 멤버카드 - 모바일: 가로형 */
            .member-card {
                width: 95%; 
                max-width: 350px; 
                min-width: unset; 
                padding: 8px 10px; 
                flex-direction: row; 
                justify-content: flex-start; 
                align-items: center;
                gap: 8px; 
            }
            .member-card:hover {
                transform: none; 
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); 
            }
            .member-card.selected {
                transform: none; 
            }

            /* 멤버 사진 - 모바일: 크기 20% 더 키움 */
            .member-card img {
                width: 72px; /* 60px * 1.2 = 72px */
                height: 72px; /* 60px * 1.2 = 72px */ 
                border-radius: 50%;
                object-fit: cover;
                margin-bottom: 0; 
                flex-shrink: 0; 
            }
            .member-card p {
                font-size: 1.1em; 
                text-align: left; 
                flex-grow: 1; 
            }
            .selection-rank {
                top: 50%; 
                left: unset; 
                right: 8px; 
                transform: translateY(-50%); 
                width: 25px; 
                height: 25px; 
                font-size: 0.9em; 
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px; 
            }
            button {
                width: 90%;
                padding: 12px 20px;
                font-size: 1.1em;
            }
            /* 게임 초기화 버튼 모바일 스타일 변경 */
            #resetGameButton {
                width: 120px; /* 더 작게 */
                padding: 8px 15px; /* 패딩도 줄임 */
                font-size: 0.9em; /* 폰트도 작게 */
                margin-top: 0; /* 상단 마진 제거 */
                align-self: center; /* 가운데 정렬 */
                order: 10; /* 다른 버튼보다 아래로 내림 */
            }

            .top-members {
                flex-direction: column; 
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%; 
                transform: none !important; 
                order: initial !important; 
            }
            .top-member-card.rank1 img {
                width: 180px; 
                height: 180px;
            }
            .top-member-card.rank2 img, .top-member-card.rank3 img {
                width: 150px;
                height: 150px;
            }
            .restart-button-group button { 
                width: 90%; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>
        <p id="instructionText" style="font-weight: bold; color: #ad1457;"></p>
        <p id="tieBreakerInfo" class="tie-breaker-info" style="display: none;">동점자 발생! 동점자 라운드를 진행합니다.</p>

        <div id="gameScreen">
            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2>오늘의 멤버를 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
                </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <div id="resultsScreen" class="results-screen">
            <h2 id="resultsScreenTitle">🎉 최종 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
                </div>
            <div class="final-selection-list">
                <h3 id="finalSelectionListTitle">💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                    </ul>
            </div>
            <div class="restart-button-group">
                <button id="downloadTextResultButton">결과 저장 (텍스트)</button>
                <button id="downloadImageResultButton">결과 저장 (이미지)</button>
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이시하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우에 네네", "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        let memberData = {};
        let currentRound = 0;
        let gamePhase = 'initialSelection'; // 'initialSelection', 'finalSelection', 'internalTieBreak', 'results'
        let selectionOrder = []; // 현재 라운드에서 선택된 멤버들의 이름 (순서대로)
        let availableMembersForRound = []; // 현재 라운드에 표시될 멤버들
        let tieBreakerMembers = []; // 동점자 라운드에 들어온 멤버들 (이름 배열)
        let tieBreakQueue = []; // 내부 동점자 라운드를 위한 대기열 (객체 {rank, members})
        let currentTieBreakInfo = null; // 현재 진행 중인 내부 동점자 라운드 정보

        const maxAppearances = 3; // 한 멤버는 3회 이상 등장하지 않음
        const membersPerRound = 3; // 게임당 보여주는 멤버 3명
        const initialSelectionTarget = 16; // 1차 선발 목표 인원

        // 점수 정의
        const scores = {
            mainRound: { // 1차 선발, 최종 선발 단계 점수
                rank1: 3,
                rank2: 1,
                rank3: 0 // 3순위는 자동선택
            },
            tieBreakRound: { // 동점자 라운드 점수
                selected: 0.3,
                unselected: 0.1, // 2인 동점시 선택되지 않은 1인
                thirdRank: 0 // 3인 이상 동점시 3순위 (자동)
            }
        };

        const instructionTextElement = document.getElementById('instructionText');
        const currentRoundElement = document.getElementById('currentRound');
        const memberSelectionDiv = document.getElementById('memberSelection');
        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const tieBreakerInfoElement = document.getElementById('tieBreakerInfo');

        function initializeGame() {
            memberData = {};
            memberNames.forEach(name => {
                memberData[name] = {
                    score: 0,
                    appearances: 0,
                    zeroScoreCount: 0, // 0점 받은 횟수 (3순위 또는 선택 없음)
                    eliminated: false, // 0점 3번 받으면 탈락
                    lastSeen: -1, // 마지막 등장 라운드
                    previousRoundGroup: new Set() // 함께 등장했던 멤버들 기록 (세트)
                };
            });
            currentRound = 0;
            gamePhase = 'initialSelection';
            selectionOrder = [];
            availableMembersForRound = [];
            tieBreakerMembers = [];
            tieBreakQueue = [];
            currentTieBreakInfo = null;

            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            tieBreakerInfoElement.style.display = 'none';

            updateInstructionText();
            startNewRound();
        }

        function updateInstructionText() {
            if (gamePhase === 'initialSelection') {
                const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated).length;
                instructionTextElement.textContent = `현재 인원: ${nonEliminatedCount}명. ${initialSelectionTarget}명을 선발 중입니다.`;
            } else if (gamePhase === 'finalSelection') {
                instructionTextElement.textContent = `최종 선발 16인 내 점수 경쟁 중입니다.`;
            } else if (gamePhase === 'internalTieBreak') {
                if (currentTieBreakInfo) {
                    const rankText = currentTieBreakInfo.rank > 0 ? `${currentTieBreakInfo.rank}위` : "동점자";
                    if (tieBreakerMembers.length === 2) {
                        instructionTextElement.textContent = `${rankText} 동점자 라운드: 이 멤버들 중 한 명을 선택하세요! (선택된 멤버 0.3점, 자동선택 0.1점)`;
                    } else { // 3명 이상
                        instructionTextElement.textContent = `${rankText} 동점자 라운드: 이 멤버들 중 1순위, 2순위를 선택하세요! (1순위 0.3점, 2순위 0.1점, 나머지 0점)`;
                    }
                }
                tieBreakerInfoElement.style.display = 'block';
            } else if (gamePhase === 'results') {
                instructionTextElement.textContent = `게임이 종료되었습니다! 최종 결과를 확인하세요.`;
                tieBreakerInfoElement.style.display = 'none';
            }
        }

        function getEligibleMembers(phase) {
            let eligible = [];
            let allMembers = Object.keys(memberData);

            if (phase === 'internalTieBreak') {
                eligible = [...tieBreakerMembers]; // 동점자 라운드는 이미 정해진 멤버들만 사용
            } else { // initialSelection 또는 finalSelection
                let candidates = allMembers.filter(name => !memberData[name].eliminated);

                if (phase === 'finalSelection') {
                    const sortedMembers = getSortedMembers(false);
                    const currentTop16Names = sortedMembers.slice(0, initialSelectionTarget).map(m => m.name);
                    candidates = candidates.filter(name => currentTop16Names.includes(name));
                }

                eligible = candidates.filter(name =>
                    memberData[name].appearances < maxAppearances &&
                    (currentRound === 0 || !memberData[name].previousRoundGroup.has(name)) // 이전 라운드에 함께 나왔던 멤버 배제
                );
            }
            return eligible;
        }

        function selectMembersForRound() {
            let selected = [];
            let eligible = [];

            if (gamePhase === 'internalTieBreak') {
                selected = [...tieBreakerMembers];
            } else {
                eligible = getEligibleMembers(gamePhase);

                let attempts = 0;
                const maxAttempts = 500; // 무한 루프 방지
                
                // 현재 라운드에서 뽑을 멤버들의 조합을 저장할 임시 배열
                let currentRoundCandidates = [];

                while (selected.length < membersPerRound && eligible.length > 0 && attempts < maxAttempts) {
                    const availableInEligible = eligible.filter(name => !selected.includes(name));
                    if (availableInEligible.length === 0) break;

                    const randomMember = availableInEligible[Math.floor(Math.random() * availableInEligible.length)];
                    
                    let canAdd = true;
                    // "같이 등장했던 멤버도 함께 나오지 않으며" 규칙 적용
                    // selected에 이미 있는 멤버들과 randomMember가 이전 라운드에서 같이 나왔던 적이 있는지 확인
                    for (const existingMember of selected) {
                        if (memberData[existingMember].previousRoundGroup.has(randomMember)) {
                            canAdd = false;
                            break;
                        }
                    }

                    if (canAdd) {
                        selected.push(randomMember);
                        // 현재 라운드에 이미 뽑힌 멤버와는 다시 나오지 않도록 eligible에서 제거 (현재 라운드 내 중복 방지)
                        eligible = eligible.filter(name => name !== randomMember); 
                    }
                    attempts++;
                }

                // 만약 3명을 뽑지 못했으면, 규칙을 완화하여 최대한 채웁니다.
                // (이 경우 "같이 등장했던 멤버가 함께 나오지 않는다"는 규칙이 깨질 수 있습니다.)
                if (selected.length < membersPerRound) {
                    const allEligibleRegardlessOfGroup = Object.keys(memberData).filter(name =>
                        !memberData[name].eliminated && memberData[name].appearances < maxAppearances && !selected.includes(name)
                    );
                    const remainingToPick = allEligibleRegardlessOfGroup.filter(name => !selected.includes(name));

                    while (selected.length < membersPerRound && remainingToPick.length > 0) {
                        const randomMember = remainingToPick.splice(Math.floor(Math.random() * remainingToPick.length), 1)[0];
                        selected.push(randomMember);
                    }
                }
            }
            
            availableMembersForRound = selected;
            renderMembers();
        }


        function startNewRound() {
            currentRound++;
            currentRoundElement.textContent = currentRound;
            selectionOrder = []; // 새 라운드 시작 시 선택 순서 초기화
            memberSelectionDiv.innerHTML = ''; // 이전 멤버 카드 제거
            tieBreakerInfoElement.style.display = 'none'; // 동점자 정보 숨김

            // 게임 페이즈 전환 및 진행 로직
            if (gamePhase === 'initialSelection') {
                const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated).length;
                if (nonEliminatedCount <= initialSelectionTarget) {
                    gamePhase = 'finalSelection';
                    currentRound = 0; // 최종 선발 라운드 카운트 초기화
                    currentRoundElement.textContent = currentRound;
                    updateInstructionText();
                    alert(`1차 선발이 완료되었습니다! 이제 최종 선발 16인을 가립니다.`);
                }
            } else if (gamePhase === 'finalSelection') {
                const eligibleFinalMembers = getEligibleMembers('finalSelection');
                // 최종 16인 내 점수 경쟁 중, 더 이상 3명을 뽑을 수 없으면 최종 동점자 확인 단계로 넘어감
                if (eligibleFinalMembers.length < membersPerRound && currentRound > 0) { // 최소 한 라운드 진행 후 검사
                    console.log("Final selection round candidates exhausted. Checking for internal tie-breakers.");
                    checkFinalResultsForTieBreaker();
                    return; // 라운드 진행 중단
                } else if (currentRound > 30 && eligibleFinalMembers.length >= membersPerRound) { // 무한 루프 방지용 임시 라운드 제한
                    console.log("Maximum final selection rounds reached. Checking for internal tie-breakers.");
                    checkFinalResultsForTieBreaker();
                    return;
                }
            } else if (gamePhase === 'internalTieBreak') {
                if (tieBreakQueue.length === 0) {
                    gamePhase = 'results'; // 모든 동점자 처리 완료
                    displayResults();
                    return;
                }
                currentTieBreakInfo = tieBreakQueue.shift(); // 큐에서 다음 동점자 그룹 가져오기
                tieBreakerMembers = currentTieBreakInfo.members; // 해당 그룹 멤버들을 동점자 라운드 대상으로 설정
                updateInstructionText(); // 동점자 라운드 안내 업데이트
            }
            updateInstructionText();
            selectMembersForRound();
        }

        function renderMembers() {
            memberSelectionDiv.innerHTML = '';
            availableMembersForRound.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <img src="./images/${name}.png" alt="${name}">
                    <p>${name}</p>
                    <div class="selection-rank"></div>
                `;
                card.addEventListener('click', handleCardClick);
                memberSelectionDiv.appendChild(card);
            });
        }

        function handleCardClick(event) {
            const clickedCard = event.currentTarget;
            const clickedMemberName = clickedCard.dataset.name;

            if (clickedCard.classList.contains('processed')) {
                return; // 이미 처리된 카드는 클릭 무시
            }

            if (selectionOrder.includes(clickedMemberName)) {
                // 이미 선택된 멤버를 다시 클릭하면 선택 취소 (마지막에 선택된 멤버만 취소)
                if (selectionOrder[selectionOrder.length - 1] === clickedMemberName) {
                    selectionOrder.pop(); // 마지막 선택 제거
                    clickedCard.classList.remove('selected');
                    clickedCard.querySelector('.selection-rank').textContent = '';
                }
                return;
            }

            let maxSelections = 0;
            if (gamePhase === 'initialSelection' || gamePhase === 'finalSelection') {
                maxSelections = 2; // 1순위, 2순위만 직접 선택
            } else if (gamePhase === 'internalTieBreak') {
                if (tieBreakerMembers.length === 2) {
                    maxSelections = 1; // 2명 동점일 땐 1명만 선택
                } else { // 3명 이상
                    maxSelections = 2; // 1순위, 2순위 선택
                }
            }

            if (selectionOrder.length < maxSelections) {
                selectionOrder.push(clickedMemberName);
                clickedCard.classList.add('selected');
                clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length + 1; // 1부터 표시

                if (selectionOrder.length === maxSelections) {
                    // 모든 직접 선택이 완료되면 다음 단계 진행 (자동 선택 및 점수 적용)
                    applyScoresAndProceed();
                }
            }
        }
        
        function applyScoresAndProceed() {
            const currentRoundMembers = availableMembersForRound; // 현재 라운드에 나온 모든 멤버

            // 모든 카드 클릭 비활성화
            document.querySelectorAll('.member-card').forEach(card => card.classList.add('processed'));

            // 3순위 자동 선택 (일반 라운드)
            if (gamePhase === 'initialSelection' || gamePhase === 'finalSelection') {
                const unselectedMember = currentRoundMembers.find(name => !selectionOrder.includes(name));
                if (unselectedMember) {
                    selectionOrder.push(unselectedMember); // 3순위로 자동 추가
                    // UI에는 3순위 표시 안함 (명시적 선택이 아니므로)
                }

                // 점수 부여
                selectionOrder.forEach((name, index) => {
                    if (index === 0) memberData[name].score += scores.mainRound.rank1; // 1순위 3점
                    else if (index === 1) memberData[name].score += scores.mainRound.rank2; // 2순위 1점
                    else if (index === 2) { // 3순위 자동선택된 멤버
                        memberData[name].score += scores.mainRound.rank3; // 3순위 0점
                        memberData[name].zeroScoreCount++; // 0점 받은 횟수 증가
                    }
                });

                // 탈락 처리
                currentRoundMembers.forEach(name => {
                    if (memberData[name].zeroScoreCount >= 3) {
                        memberData[name].eliminated = true; // 0점을 3번 받으면 탈락
                    }
                });

            } else if (gamePhase === 'internalTieBreak') {
                // 동점자 라운드 점수 처리
                if (tieBreakerMembers.length === 2) {
                    const selectedMember = selectionOrder[0];
                    const unselectedMember = tieBreakerMembers.find(name => name !== selectedMember); // 자동 추가된 멤버

                    memberData[selectedMember].score += scores.tieBreakRound.selected; // 선택받은 사람은 0.3점
                    if (unselectedMember) {
                        memberData[unselectedMember].score += scores.tieBreakRound.unselected; // 선택 못받은 사람은 0.1점
                    }

                } else if (tieBreakerMembers.length >= 3) {
                    // 3명 이상 동점자 라운드: 1순위, 2순위 선택, 나머지 자동 3순위
                    const rank1Member = selectionOrder[0];
                    const rank2Member = selectionOrder[1];
                    const rank3Member = tieBreakerMembers.find(name => !selectionOrder.includes(name)); // 자동 추가된 멤버

                    memberData[rank1Member].score += scores.tieBreakRound.selected; // 1순위 0.3점
                    memberData[rank2Member].score += scores.tieBreakRound.unselected; // 2순위 0.1점
                    if (rank3Member) {
                        memberData[rank3Member].score += scores.tieBreakRound.thirdRank;   // 3순위 0점
                    }
                }
            }

            // 모든 멤버들의 등장 횟수 및 마지막 등장 라운드, 함께 등장했던 멤버 기록 업데이트
            currentRoundMembers.forEach(name => {
                memberData[name].appearances++;
                memberData[name].lastSeen = currentRound; // 현재 라운드 기록

                // "같이 등장했던 멤버도 함께 나오지 않으며" 규칙을 위한 기록
                memberData[name].previousRoundGroup.clear(); // 이전 라운드 그룹 초기화
                currentRoundMembers.forEach(otherName => {
                    if (name !== otherName) {
                        memberData[name].previousRoundGroup.add(otherName);
                    }
                });
            });

            // 잠시 딜레이 후 다음 라운드 시작
            setTimeout(() => {
                startNewRound();
            }, 100); // 0.1초 후 다음 라운드 진행
        }

        function getSortedMembers(includeEliminated = true) {
            let sortable = [];
            for (let name in memberData) {
                if (includeEliminated || !memberData[name].eliminated) {
                    sortable.push({ name: name, score: memberData[name].score });
                }
            }
            // 점수가 같으면 이름으로 정렬 (동점 시 순서 고정)
            sortable.sort((a, b) => {
                if (b.score === a.score) {
                    return a.name.localeCompare(b.name);
                }
                return b.score - a.score;
            });
            return sortable;
        }

        function checkFinalResultsForTieBreaker() {
            const sortedMembers = getSortedMembers(false); // 탈락자 제외
            let final16List = []; // 최종 16인 목록
            let tempTieBreakQueue = []; // 16인 선발 라인 동점자 처리를 위한 임시 큐

            // 1단계: 16위 컷오프 동점자 처리 (16인 초과 방지)
            if (sortedMembers.length > initialSelectionTarget) {
                const cutoffScore = sortedMembers[initialSelectionTarget - 1].score;
                const membersAtCutoff = sortedMembers.filter(m => m.score === cutoffScore);

                // 16위권에 동점자가 여러 명 있을 경우 (예: 15위까지 다른 점수, 16,17,18위가 동점)
                // 이 동점자들 중에서 initialSelectionTarget - (16위 이전까지의 확정된 멤버 수) 만큼 뽑아야 함
                const definiteTopMembers = sortedMembers.filter(m => m.score > cutoffScore);
                const neededFromTieGroup = initialSelectionTarget - definiteTopMembers.length;

                if (membersAtCutoff.length > neededFromTieGroup) {
                    console.log("16인 컷오프 동점자 발생:", membersAtCutoff.map(m=>m.name));
                    // 필요한 인원보다 동점자가 많으면 동점자 라운드 생성
                    tempTieBreakQueue.push({
                        rank: -1, // 컷오프 동점자는 특정 순위가 아님
                        members: membersAtCutoff.map(m => m.name),
                        needed: neededFromTieGroup
                    });
                }
            }

            if (tempTieBreakQueue.length > 0) {
                // 16인 컷오프 동점자 라운드를 먼저 진행
                gamePhase = 'internalTieBreak';
                tieBreakQueue = tempTieBreakQueue; // 큐에 추가
                // 동점자 라운드 진행 시에는 currentRound를 유지하되, 별도 타이틀로 구분
                currentRoundElement.textContent = "동점자"; 
                startNewRound();
                return;
            } else {
                // 16인 컷오프 동점자가 없거나 이미 처리된 경우 최종 16인 확정
                final16List = sortedMembers.slice(0, initialSelectionTarget);
            }

            // 2단계: 최종 16인 내부 동점자 처리
            // 이미 final16List가 16인으로 확정된 상태에서, 상위 순위 동점자 확인
            const ranksToCheck = [1, 2, 3]; // 1위, 2위, 3위만 동점자 라운드 진행
            for (let i = 0; i < ranksToCheck.length; i++) {
                const currentRank = ranksToCheck[i];
                if (final16List.length < currentRank) break; // 16인 미만이거나 해당 순위가 없는 경우

                const memberAtRank = final16List[currentRank - 1];
                if (!memberAtRank) continue;

                const scoreAtRank = memberAtRank.score;
                const tieGroup = final16List.filter(m => m.score === scoreAtRank);
                
                // 해당 순위에 동점자가 있고, 그 수가 해당 순위부터 다음 순위까지의 간격보다 클 경우 (예: 1위가 2명)
                // 또는 동점자 그룹이 시작되는 인덱스가 현재 순위 인덱스와 일치하는 경우 (예: 1위가 A, B 동점)
                const tieGroupStartIndex = final16List.findIndex(m => m.score === scoreAtRank);
                
                // 동점자 그룹의 크기가, 현재 순위에서 시작하여 다음 순위까지 할당될 수 있는 자리보다 많을 때
                // 예를 들어, 1위가 2명인데 1위 자리는 1개일 때
                if (tieGroup.length > 1 && tieGroupStartIndex <= currentRank - 1) { // 동점자가 있고, 해당 랭크에 걸쳐있음
                    // 그리고 이 동점자 그룹이 현재 처리하려는 랭크에 명확히 걸쳐있어야 함 (예: 1등 결정인데 1등이 2명)
                    // 현재 동점자 그룹 내에서 해당 순위의 정확한 위치를 찾아야 합니다.
                    // 동점자 그룹이 시작하는 인덱스(tieGroupStartIndex)가 현재 순위보다 작거나 같고,
                    // 동점자 그룹의 끝 인덱스가 현재 순위보다 크거나 같을 때
                    const actualMembersForTieBreak = tieGroup.filter(m => m.score === scoreAtRank);

                    // 이전에 이 동점자 그룹이 이미 처리되었는지 확인
                    // 이 부분은 멤버들의 점수가 계속 바뀌므로 이전 기록만으로는 체크하기 어려움.
                    // 대신, 동점자 큐에 이미 같은 멤버들로 구성된 라운드가 있는지 확인하는 식으로 방지해야 함.

                    const existingInQueue = tieBreakQueue.some(item => 
                        item.members.length === actualMembersForTieBreak.length && 
                        item.members.every(name => actualMembersForTieBreak.map(m=>m.name).includes(name))
                    );

                    if (!existingInQueue) {
                        console.log(`내부 동점자 발생 (${currentRank}위):`, actualMembersForTieBreak.map(m=>m.name));
                        tieBreakQueue.push({
                            rank: currentRank,
                            members: actualMembersForTieBreak.map(m => m.name),
                            needed: 1 // 동점자 라운드를 통해 해당 순위 1명만 결정
                        });
                    }
                }
            }

            if (tieBreakQueue.length > 0) {
                gamePhase = 'internalTieBreak';
                currentRoundElement.textContent = "동점자"; // 동점자 라운드는 라운드 카운트 대신 '동점자' 표시
                startNewRound();
            } else {
                gamePhase = 'results';
                displayResults();
            }
        }


        function displayResults() {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            updateInstructionText();

            const sortedMembers = getSortedMembers(false); // 최종 선발 멤버 (탈락자 제외)

            // Top 3 멤버 표시
            topMembersDisplay.innerHTML = '';
            for (let i = 0; i < Math.min(3, sortedMembers.length); i++) {
                const member = sortedMembers[i];
                const rank = i + 1;
                const card = document.createElement('div');
                card.classList.add('top-member-card', `rank${rank}`);
                card.innerHTML = `
                    <div class="rank-label">${rank}위</div>
                    <img src="./images/${member.name}.png" alt="${member.name}">
                    <p>${member.name}</p>
                    <span class="score">점수: ${member.score.toFixed(1)}</span>
                `;
                topMembersDisplay.appendChild(card);
            }

            // 최종 16인 리스트 표시 (혹은 남은 멤버 모두)
            finalSelectionList.innerHTML = '';
            const finalCount = Math.min(initialSelectionTarget, sortedMembers.length); // 최대 16명
            for (let i = 0; i < finalCount; i++) {
                const member = sortedMembers[i];
                const listItem = document.createElement('li');
                listItem.textContent = `${i + 1}위: ${member.name} (${member.score.toFixed(1)}점)`;
                finalSelectionList.appendChild(listItem);
            }
            document.getElementById('finalSelectionListTitle').textContent = `💖 최종 선발 ${finalCount}인 💖`;
        }

        // 텍스트 결과 저장 기능
        document.getElementById('downloadTextResultButton').addEventListener('click', () => {
            const sortedMembers = getSortedMembers(false);
            let textContent = "MY HKT48 선발 최종 결과\n\n";

            textContent += "--- Top 3 ---\n";
            for (let i = 0; i < Math.min(3, sortedMembers.length); i++) {
                const member = sortedMembers[i];
                textContent += `${i + 1}위: ${member.name} (${member.score.toFixed(1)}점)\n`;
            }
            textContent += "\n";

            textContent += "--- 최종 선발 16인 (혹은 남은 멤버) ---\n";
            const finalCount = Math.min(initialSelectionTarget, sortedMembers.length);
            for (let i = 0; i < finalCount; i++) {
                const member = sortedMembers[i];
                textContent += `${i + 1}위: ${member.name} (${member.score.toFixed(1)}점)\n`;
            }

            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'HKT48_Senbatsu_Results.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // 이미지 결과 저장 기능 (html2canvas 사용)
        document.getElementById('downloadImageResultButton').addEventListener('click', () => {
            html2canvas(document.querySelector('.container'), {
                useCORS: true, // 크로스 오리진 이미지 로드 허용 (필요시)
                scale: 2, // 고해상도 이미지를 위해 스케일 조정
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'HKT48_Senbatsu_Results.png';
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });


        // 게임 초기화 버튼 이벤트 리스너
        document.getElementById('resetGameButton').addEventListener('click', () => {
            if (confirm("게임을 정말 초기화하시겠습니까? 현재 진행 상황은 저장되지 않습니다.")) {
                initializeGame();
            }
        });

        // 새 게임 시작 버튼 이벤트 리스너 (결과 화면에서)
        document.getElementById('restartGameButton').addEventListener('click', () => {
            initializeGame();
        });

        // 게임 시작
        initializeGame();
    </script>
</body>
</html>
