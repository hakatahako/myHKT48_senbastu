<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        /* 바닥판 */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1160px; 
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 15px; 
            margin-top: 30px;
        }
        /* 멤버카드 (분홍색 판) - PC 기본 스타일 */
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 15px; /* PC 패딩 줄임 */
            width: 370px; 
            min-width: 370px; 
            flex-shrink: 0; 
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column; /* PC: 세로형 */
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        .member-card.processed {
            pointer-events: none;
            opacity: 0.8;
        }

        /* 멤버 사진 - PC 기본 스타일 */
        .member-card img {
            width: 350px; 
            height: 350px; 
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px; /* PC 이미지 아래 여백 줄임 */
            transition: border-color 0.2s;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            margin-top: 20px; /* PC에서는 기존 위치 유지 */
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center; 
            align-items: flex-end; 
            gap: 30px; /* 이미지 크기 증가에 맞춰 간격 조정 */
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 30px; /* 패딩 늘림 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        /* 1위 카드 스타일 (2,3위보다 10% 더 크게) */
        .top-member-card.rank1 {
            width: calc(247.5px + 60px + 8px); 
            height: auto; 
            border: 4px solid #FFD700; 
            background-color: #FFFACD;
            transform: translateY(-30px); 
            order: 2; 
        }
        .top-member-card.rank1 img {
            width: 247.5px; 
            height: 247.5px; 
        }

        /* 2, 3위 카드 스타일 (기준 크기) */
        .top-member-card.rank2, .top-member-card.rank3 {
            width: calc(225px + 60px + 8px); 
            height: auto; 
            border: 4px solid #C0C0C0; 
            background-color: #E0E0E0;
            order: 1; 
        }
        .top-member-card.rank3 {
            border: 4px solid #CD7F32; 
            background-color: #D2B48C;
            order: 3; 
        }
        .top-member-card.rank2 img, .top-member-card.rank3 img {
            width: 225px; 
            height: 225px; 
        }
        
        .top-member-card img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }
        .top-member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
            display: none; 
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 15px; 
        }
        .restart-button-group button {
            width: 250px; 
        }
        /* 동점자 라운드 시 표시될 안내 텍스트 스타일 */
        .tie-breaker-info {
            font-weight: bold;
            color: #ad1457;
            font-size: 1.1em;
            margin-bottom: 15px;
            animation: pulse 1.5s infinite alternate; /* 깜빡이는 효과 */
        }

        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                max-width: 95%; 
            }
            h1 {
                font-size: 1.8em;
            }
            /* 모바일에서 라운드 정보와 '오늘의 멤버' 문구 숨김 */
            .round-info, h2 {
                display: none;
            }
            /* 모바일 상단 안내 글자 간략화 및 크기 조정 */
            #instructionText {
                font-size: 0.9em; 
                margin-top: 0; 
                margin-bottom: 15px; 
            }
            .tie-breaker-info { /* 모바일에서 동점자 안내 텍스트 크기 조정 */
                font-size: 0.9em;
            }


            .member-display {
                flex-direction: column; 
                align-items: center;
                gap: 10px; 
                margin-top: 15px; 
            }
            /* 멤버카드 - 모바일: 가로형 */
            .member-card {
                width: 95%; 
                max-width: 350px; 
                min-width: unset; 
                padding: 8px 10px; 
                flex-direction: row; 
                justify-content: flex-start; 
                align-items: center;
                gap: 8px; 
            }
            .member-card:hover {
                transform: none; 
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); 
            }
            .member-card.selected {
                transform: none; 
            }

            /* 멤버 사진 - 모바일: 크기 20% 더 키움 */
            .member-card img {
                width: 72px; /* 60px * 1.2 = 72px */
                height: 72px; /* 60px * 1.2 = 72px */ 
                border-radius: 50%;
                object-fit: cover;
                margin-bottom: 0; 
                flex-shrink: 0; 
            }
            .member-card p {
                font-size: 1.1em; 
                text-align: left; 
                flex-grow: 1; 
            }
            .selection-rank {
                top: 50%; 
                left: unset; 
                right: 8px; 
                transform: translateY(-50%); 
                width: 25px; 
                height: 25px; 
                font-size: 0.9em; 
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px; 
            }
            button {
                width: 90%;
                padding: 12px 20px;
                font-size: 1.1em;
            }
            /* 게임 초기화 버튼 모바일 스타일 변경 */
            #resetGameButton {
                width: 120px; /* 더 작게 */
                padding: 8px 15px; /* 패딩도 줄임 */
                font-size: 0.9em; /* 폰트도 작게 */
                margin-top: 0; /* 상단 마진 제거 */
                align-self: center; /* 가운데 정렬 */
                order: 10; /* 다른 버튼보다 아래로 내림 */
            }

            .top-members {
                flex-direction: column; 
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%; 
                transform: none !important; 
                order: initial !important; 
            }
            .top-member-card.rank1 img {
                width: 180px; 
                height: 180px;
            }
            .top-member-card.rank2 img, .top-member-card.rank3 img {
                width: 150px;
                height: 150px;
            }
            .restart-button-group button { 
                width: 90%; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>
        <p id="instructionText" style="font-weight: bold; color: #ad1457;"></p>
        <p id="tieBreakerInfo" class="tie-breaker-info" style="display: none;">동점자 발생! 동점자 라운드를 진행합니다.</p>

        <div id="gameScreen">
            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2>오늘의 멤버를 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
                </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <div id="resultsScreen" class="results-screen">
            <h2 id="resultsScreenTitle">🎉 최종 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
                </div>
            <div class="final-selection-list">
                <h3 id="finalSelectionListTitle">💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                    </ul>
            </div>
            <div class="restart-button-group">
                <button id="downloadTextResultButton">결과 저장 (텍스트)</button>
                <button id="downloadImageResultButton">결과 저장 (이미지)</button>
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이시하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우에 네네", "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌", "하카타 하나"
        ];

        let memberData = {};
        let currentRound = 0;
        let gamePhase = 'initialSelection'; // 'initialSelection', 'finalSelection', 'tieBreakRound', 'results'
        let selectionOrder = []; // 현재 라운드에서 선택된 멤버들의 이름 (순서대로)
        let availableMembersForRound = []; // 현재 라운드에 표시될 멤버들
        let tieBreakerMembers = []; // 동점자 라운드에 들어온 멤버들

        const maxAppearances = 3; // 한 멤버는 3회 이상 등장하지 않음
        const membersPerRound = 4; // 게임당 보여주는 멤버 4명
        const initialSelectionTarget = 16; // 1차 선발 목표 인원

        // 점수 정의
        const scores = {
            initialSelection: {
                rank1: 3,
                rank2: 2,
                rank3: 1,
                rank4: 0
            },
            finalSelection: { // 최종 선발 단계 점수 (일반 선발과 동일)
                rank1: 3,
                rank2: 2,
                rank3: 1,
                rank4: 0
            },
            tieBreakRound: { // 동점자 라운드 점수 (각각의 경우 로직 내에서 처리)
                // 2명일 때: 1순위 0.3점, 2순위 0.1점
                // 3명일 때: 1순위 0.3점, 2순위 0.1점, 3순위 0점
            }
        };

        const instructionTextElement = document.getElementById('instructionText');
        const currentRoundElement = document.getElementById('currentRound');
        const memberSelectionDiv = document.getElementById('memberSelection');
        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const tieBreakerInfoElement = document.getElementById('tieBreakerInfo');

        function initializeGame() {
            memberData = {};
            memberNames.forEach(name => {
                memberData[name] = {
                    score: 0,
                    appearances: 0,
                    rank3Count: 0, // 0점 받은 횟수 (예전 3순위/선택없음 0점)
                    eliminated: false, // 0점 3번 받으면 탈락
                    lastSeen: -1 // 마지막 등장 라운드 (중복 등장 방지용)
                };
            });
            currentRound = 0;
            gamePhase = 'initialSelection';
            selectionOrder = [];
            availableMembersForRound = [];
            tieBreakerMembers = [];

            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            tieBreakerInfoElement.style.display = 'none';

            updateInstructionText();
            startNewRound();
        }

        function updateInstructionText() {
            if (gamePhase === 'initialSelection') {
                const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated).length;
                instructionTextElement.textContent = `현재 인원: ${nonEliminatedCount}명. ${initialSelectionTarget}명을 선발 중입니다.`;
            } else if (gamePhase === 'finalSelection') {
                instructionTextElement.textContent = `최종 선발 16인 내 점수 경쟁 중입니다.`;
            } else if (gamePhase === 'tieBreakRound') {
                if (tieBreakerMembers.length === 2) {
                    instructionTextElement.textContent = `동점자 라운드: 이 멤버들 중 한 명을 선택하세요! (선택된 멤버 0.3점, 자동선택 0.1점)`;
                } else { // 3명 이상
                    instructionTextElement.textContent = `동점자 라운드: 이 멤버들 중 1순위, 2순위를 선택하세요! (1순위 0.3점, 2순위 0.1점, 3순위 0점)`;
                }
                tieBreakerInfoElement.style.display = 'block';
            } else if (gamePhase === 'results') {
                instructionTextElement.textContent = `게임이 종료되었습니다! 최종 결과를 확인하세요.`;
                tieBreakerInfoElement.style.display = 'none';
            }
        }

        function getEligibleMembers(phase) {
            let eligible = [];
            if (phase === 'initialSelection') {
                eligible = Object.keys(memberData).filter(name =>
                    !memberData[name].eliminated &&
                    memberData[name].appearances < maxAppearances &&
                    (currentRound - memberData[name].lastSeen > 0 || memberData[name].lastSeen === -1) // 같은 라운드에 다시 나오지 않음
                );
            } else if (phase === 'finalSelection') {
                // 최종 16인에 포함된 멤버만 대상으로 함 (탈락자 제외)
                const sortedMembers = getSortedMembers(false);
                const currentTop16Names = sortedMembers.slice(0, initialSelectionTarget).map(m => m.name);
                
                // Top 16 멤버 중에서만 다음 라운드에 나올 멤버를 선택 (3회 등장 제한 및 같은 라운드 중복 등장 방지)
                eligible = currentTop16Names.filter(name =>
                    memberData[name].appearances < maxAppearances &&
                    (currentRound - memberData[name].lastSeen > 0 || memberData[name].lastSeen === -1)
                );
            } else if (phase === 'tieBreakRound') {
                eligible = [...tieBreakerMembers]; // 동점자 라운드는 이미 정해진 멤버들만 사용
            }
            return eligible;
        }

        function selectMembersForRound() {
            let selected = [];
            let eligible = [];

            if (gamePhase === 'tieBreakRound') {
                selected = [...tieBreakerMembers]; // 동점자 라운드는 동점자들로만 구성
            } else { // initialSelection 또는 finalSelection
                eligible = getEligibleMembers(gamePhase);

                // 이전에 같이 등장했던 멤버를 제외하는 로직
                // `selectionOrder`는 현재 라운드에서 선택된 멤버이므로, 이전 라운드에 같이 등장했던 멤버를 추적하려면
                // 별도의 전역 변수 (예: `previousRoundDisplayedMembers`)를 사용하거나,
                // `lastSeen` 변수를 활용하는 것이 더 정확합니다.
                // 현재 `selectionOrder`는 매 라운드 초기화되므로, "같이 등장했던 멤버도 함께 나오지 않으며"를 구현하려면
                // 좀 더 복잡한 로직이 필요합니다. 여기서는 단순하게 `lastSeen`이 현재 라운드와 같은 멤버는 제외합니다.
                // 즉, 한 라운드에 4명 중 3명이 선택되고 1명이 선택되지 않았을 때,
                // 다음 라운드에 이 4명 모두가 나오지 않도록 하는 것 (lastSeen 기반).
                // "같이 등장했던 멤버도 함께 나오지 않으며"는 한 번 같은 선택지에 나온 멤버는 다음 라운드에 같이 나오지 않는다는 의미로 해석.
                // 이 경우 `lastSeen`만으로는 부족하고, 그룹 히스토리를 저장해야 합니다.
                // 복잡성을 줄이기 위해 현재는 `lastSeen`이 같은 멤버 (즉, 이전 라운드에 등장했던 멤버)는 제외하는 로직으로 유지합니다.

                let attempts = 0;
                const maxAttempts = 200; // 무한 루프 방지

                while (selected.length < membersPerRound && eligible.length > 0 && attempts < maxAttempts) {
                    let foundCandidate = false;
                    const shuffledEligible = eligible.sort(() => 0.5 - Math.random()); // 무작위로 섞기
                    
                    for (const candidate of shuffledEligible) {
                        // 현재 라운드에 이미 선택된 멤버가 아니고
                        // (이전 라운드에 같이 나왔던 멤버를 방지하는 로직은 currentRound - memberData[name].lastSeen > 0 로 처리됨)
                        if (!selected.includes(candidate)) {
                            selected.push(candidate);
                            foundCandidate = true;
                            // eligible 배열에서 제거하여 중복 선택 방지
                            eligible = eligible.filter(name => name !== candidate);
                            break; 
                        }
                    }
                    if (!foundCandidate) {
                        // 더 이상 조건에 맞는 멤버를 찾을 수 없으면 루프 종료
                        break;
                    }
                    attempts++;
                }

                // 만약 4명을 뽑지 못했으면 (자격 있는 멤버가 부족하거나, 필터링 조건 때문에),
                // 현재 가능한 모든 멤버를 넣어 최대한 채웁니다.
                // 이 경우 "같이 등장했던 멤버가 함께 나오지 않는다"는 규칙이 깨질 수 있습니다.
                // 하지만 모든 멤버를 포함시켜 게임을 진행하기 위함입니다.
                if (selected.length < membersPerRound) {
                    const allEligibleRegardlessOfLastSeen = Object.keys(memberData).filter(name =>
                        !memberData[name].eliminated && memberData[name].appearances < maxAppearances
                    );
                    const remainingToPick = allEligibleRegardlessOfLastSeen.filter(name => !selected.includes(name));

                    while (selected.length < membersPerRound && remainingToPick.length > 0) {
                        const randomMember = remainingToPick.splice(Math.floor(Math.random() * remainingToPick.length), 1)[0];
                        selected.push(randomMember);
                    }
                }
            }
            
            availableMembersForRound = selected;
            renderMembers();
        }


        function startNewRound() {
            currentRound++;
            currentRoundElement.textContent = currentRound;
            selectionOrder = []; // 새 라운드 시작 시 선택 순서 초기화
            memberSelectionDiv.innerHTML = ''; // 이전 멤버 카드 제거
            tieBreakerInfoElement.style.display = 'none'; // 동점자 정보 숨김

            // 게임 페이즈 전환 로직
            if (gamePhase === 'initialSelection') {
                const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated).length;
                if (nonEliminatedCount <= initialSelectionTarget) {
                    gamePhase = 'finalSelection';
                    currentRound = 0; // 최종 선발 라운드 카운트 초기화
                    currentRoundElement.textContent = currentRound;
                    updateInstructionText();
                    alert(`1차 선발이 완료되었습니다! 이제 최종 선발 16인을 가립니다.`);
                }
            } else if (gamePhase === 'finalSelection') {
                // 최종 선발 멤버들을 계속 뽑아 3회 등장 제한에 걸리거나,
                // 더 이상 유효한 멤버 조합이 없으면 게임 종료 또는 동점자 확인
                const eligibleFinalMembers = getEligibleMembers('finalSelection');
                
                // 더 이상 4명을 뽑을 수 없거나, 최종 16인 안에 있는 멤버 중
                // 이미 3회 등장했거나, 모두 탈락해서 더 이상 뽑을 수 없는 경우
                if (eligibleFinalMembers.length < membersPerRound || currentRound >= 30) { // 너무 많은 라운드 방지 (임시)
                    console.log("Final selection complete or no more valid combinations.");
                    checkFinalResultsForTieBreaker();
                    return; // 라운드 진행 중단
                }
            }
            updateInstructionText();
            selectMembersForRound();
        }

        function renderMembers() {
            memberSelectionDiv.innerHTML = '';
            availableMembersForRound.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <img src="./images/${name}.png" alt="${name}">
                    <p>${name}</p>
                    <div class="selection-rank"></div>
                `;
                card.addEventListener('click', handleCardClick);
                memberSelectionDiv.appendChild(card);
            });
        }

        function handleCardClick(event) {
            const clickedCard = event.currentTarget;
            const clickedMemberName = clickedCard.dataset.name;

            if (clickedCard.classList.contains('processed')) {
                return; // 이미 처리된 카드는 클릭 무시
            }

            if (selectionOrder.includes(clickedMemberName)) {
                // 이미 선택된 멤버를 다시 클릭하면 선택 취소 (마지막에 선택된 멤버만 취소)
                if (selectionOrder[selectionOrder.length - 1] === clickedMemberName) {
                    selectionOrder.pop(); // 마지막 선택 제거
                    clickedCard.classList.remove('selected');
                    clickedCard.querySelector('.selection-rank').textContent = '';
                }
                return;
            }

            let maxSelections = 0;
            if (gamePhase === 'initialSelection' || gamePhase === 'finalSelection') {
                maxSelections = 3; // 1순위, 2순위, 3순위
            } else if (gamePhase === 'tieBreakRound') {
                if (tieBreakerMembers.length === 2) {
                    maxSelections = 1; // 2명 동점일 땐 1명만 선택
                } else { // 3명 이상 동점일 땐 2명 선택 (1순위, 2순위)
                    maxSelections = 2;
                }
            }

            if (selectionOrder.length < maxSelections) {
                selectionOrder.push(clickedMemberName);
                clickedCard.classList.add('selected');
                clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length;

                if (selectionOrder.length === maxSelections) {
                    // 모든 선택이 완료되면 다음 단계 진행 전 자동 선택 로직
                    if (gamePhase === 'tieBreakRound') {
                        if (tieBreakerMembers.length === 2 && selectionOrder.length === 1) {
                            // 2명 동점자 라운드에서 1명만 선택한 경우, 나머지 한 명을 자동으로 2순위로 추가
                            const unselectedMember = tieBreakerMembers.find(name => !selectionOrder.includes(name));
                            if (unselectedMember) {
                                selectionOrder.push(unselectedMember);
                                // 화면에 표시되지 않는 자동 선택이므로, .selection-rank는 업데이트하지 않음
                            }
                        } else if (tieBreakerMembers.length >= 3 && selectionOrder.length === 2) {
                            // 3명 이상 동점자 라운드에서 2명만 선택한 경우, 나머지 한 명을 자동으로 3순위로 추가
                            const unselectedMember = tieBreakerMembers.find(name => !selectionOrder.includes(name));
                            if (unselectedMember) {
                                selectionOrder.push(unselectedMember);
                            }
                        }
                    }
                    // 모든 선택이 완료되었으니, 점수 적용 및 다음 라운드로 진행
                    applyScoresAndProceed();
                }
            }
        }
        
        function applyScoresAndProceed() {
            const currentRoundMembers = availableMembersForRound; // 현재 라운드에 나온 모든 멤버

            // 모든 카드 클릭 비활성화
            document.querySelectorAll('.member-card').forEach(card => card.classList.add('processed'));

            if (gamePhase === 'initialSelection' || gamePhase === 'finalSelection') {
                // 선택된 멤버들에게 점수 부여
                selectionOrder.forEach((name, index) => {
                    if (index === 0) memberData[name].score += scores[gamePhase].rank1; // 1순위 3점
                    else if (index === 1) memberData[name].score += scores[gamePhase].rank2; // 2순위 2점
                    else if (index === 2) memberData[name].score += scores[gamePhase].rank3; // 3순위 1점
                });

                // 선택되지 않은 멤버들 처리 (0점)
                const unselectedMembers = currentRoundMembers.filter(name => !selectionOrder.includes(name));
                unselectedMembers.forEach(name => {
                    memberData[name].score += scores[gamePhase].rank4; // 0점 부여
                    memberData[name].rank3Count++; // 0점 받은 횟수 증가
                    if (memberData[name].rank3Count >= 3) {
                        memberData[name].eliminated = true; // 0점을 3번 받으면 탈락
                    }
                });

            } else if (gamePhase === 'tieBreakRound') {
                if (selectionOrder.length === 2 && tieBreakerMembers.length === 2) {
                    // 2명 동점자 라운드: 1명 선택, 나머지 자동 선택
                    const selectedMember = selectionOrder[0];
                    const unselectedMember = selectionOrder[1]; // 자동 추가된 멤버

                    memberData[selectedMember].score += 0.3; // 선택받은 사람은 0.3점
                    memberData[unselectedMember].score += 0.1; // 선택 못받은 사람은 0.1점

                } else if (selectionOrder.length === 3 && tieBreakerMembers.length >= 3) {
                    // 3명 이상 동점자 라운드: 1순위, 2순위 선택, 나머지 자동 3순위
                    const rank1Member = selectionOrder[0];
                    const rank2Member = selectionOrder[1];
                    const rank3Member = selectionOrder[2]; // 자동 추가된 멤버 (선택되지 않은 1명)

                    memberData[rank1Member].score += 0.3; // 1순위 0.3점
                    memberData[rank2Member].score += 0.1; // 2순위 0.1점
                    memberData[rank3Member].score += 0;   // 3순위 0점 (사용자 요청 반영)

                }
            }

            // 모든 멤버들의 등장 횟수 및 마지막 등장 라운드 업데이트
            currentRoundMembers.forEach(name => {
                memberData[name].appearances++;
                memberData[name].lastSeen = currentRound; // 현재 라운드 기록
            });

            // 잠시 딜레이 후 다음 라운드 시작
            setTimeout(() => {
                if (gamePhase === 'tieBreakRound') {
                    // 동점자 라운드 종료 후 다시 최종 결과 확인
                    checkFinalResultsForTieBreaker();
                } else {
                    startNewRound();
                }
            }, 1500); // 1.5초 후 다음 라운드 진행
        }

        function getSortedMembers(includeEliminated = true) {
            let sortable = [];
            for (let name in memberData) {
                if (includeEliminated || !memberData[name].eliminated) {
                    sortable.push({ name: name, score: memberData[name].score });
                }
            }
            // 점수가 같으면 이름으로 정렬 (동점 시 순서 고정)
            sortable.sort((a, b) => {
                if (b.score === a.score) {
                    return a.name.localeCompare(b.name);
                }
                return b.score - a.score;
            });
            return sortable;
        }

        function checkFinalResultsForTieBreaker() {
            const sortedMembers = getSortedMembers(false); // 탈락자 제외
            let top16Members = sortedMembers.slice(0, 16);
            
            // 16위와 그 다음 순위 사이에 동점자가 있는지 확인
            // 혹은 16위권 내에 동점자가 여러 명 있어 16명을 초과하는지 확인
            let final16CutoffScore = -1;
            if (top16Members.length === 16) {
                final16CutoffScore = top16Members[15].score; // 16위의 점수
            } else if (top16Members.length < 16) {
                // 아직 16명도 안 되는 경우, 동점자 라운드 없이 바로 결과 표시
                gamePhase = 'results';
                displayResults();
                return;
            }

            // 16위의 점수와 동일한 모든 멤버를 찾습니다.
            const candidatesForTieBreak = sortedMembers.filter(m => m.score === final16CutoffScore);

            // 후보군이 정확히 16명이라면 동점자 없음
            if (candidatesForTieBreak.length === 16) {
                gamePhase = 'results';
                displayResults();
                return;
            }

            // 16위의 점수와 동일한 멤버가 16명보다 많을 때 (즉, 16위권에 동점자가 있어 초과될 때)
            // 혹은 16위 안에 동점자가 있어, 그 다음 순위 멤버와 점수가 같을 때 (16위 그룹이 확장될 때)
            // 여기서는 `candidatesForTieBreak`가 16위 그룹의 멤버들을 정확히 지칭합니다.
            // 예를 들어, 15등까지 점수 다르고 16,17,18등이 모두 동점일 경우, candidatesForTieBreak는 이 3명.
            // 그리고 이 중 1명만 16위로 올라갈 수 있다면, 나머지 2명은 탈락해야 합니다.
            // -> 이 부분을 정확히 판단해야 합니다.
            
            // 15위까지 점수가 다르고 16, 17, 18위가 모두 5.0점이라고 가정.
            // sortedMembers[15]는 16위 멤버, sortedMembers[16]는 17위 멤버, sortedMembers[17]는 18위 멤버.
            // 모두 점수가 5.0점으로 동일. 이 셋 중 한 명만 16위가 될 수 있다면, 이 셋이 동점자 그룹.
            
            // 16위 라인에 걸쳐있는 동점자 그룹을 찾기
            let tieGroupStartIndex = -1;
            let tieGroupEndIndex = -1;

            if (sortedMembers.length > 0) {
                const targetScore = sortedMembers[Math.min(15, sortedMembers.length - 1)].score; // 16번째 멤버의 점수 (또는 마지막 멤버)

                for (let i = 0; i < sortedMembers.length; i++) {
                    if (sortedMembers[i].score === targetScore) {
                        if (tieGroupStartIndex === -1) {
                            tieGroupStartIndex = i;
                        }
                        tieGroupEndIndex = i;
                    } else if (tieGroupStartIndex !== -1) {
                        // 점수가 달라지면 동점자 그룹 끝
                        break;
                    }
                }
            }

            // 동점자 그룹이 존재하고, 그 그룹이 최종 16인에 영향을 미칠 때만 동점자 라운드 진행
            if (tieGroupStartIndex !== -1 && tieGroupEndIndex >= 15 && tieGroupEndIndex + 1 > 16) {
                // 예를 들어, 15위가 다른 점수이고 16, 17, 18위가 동점 (총 3명).
                // 이 3명 중에서 1명을 16위로 뽑아야 한다.
                // 동점자 라운드에 보낼 멤버는 sortedMembers.slice(tieGroupStartIndex, tieGroupEndIndex + 1)
                
                const currentRankedCount = tieGroupStartIndex; // 이미 순위가 확정된 (동점자가 아닌) 멤버 수
                const membersNeededFromTieGroup = 16 - currentRankedCount; // 동점자 그룹에서 16인을 채우기 위해 필요한 멤버 수
                const actualTieBreakerCandidates = sortedMembers.slice(tieGroupStartIndex, tieGroupEndIndex + 1);

                if (actualTieBreakerCandidates.length > membersNeededFromTieGroup) {
                    tieBreakerMembers = actualTieBreakerCandidates.map(m => m.name);
                    gamePhase = 'tieBreakRound';
                    startNewRound(); // 동점자 라운드 시작
                    return;
                }
            }

            // 위의 조건에 해당하지 않으면 동점자 라운드 없이 최종 결과 표시
            gamePhase = 'results';
            displayResults();
        }


        function displayResults() {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            updateInstructionText();

            const sortedMembers = getSortedMembers(false); // 최종 선발 멤버 (탈락자 제외)

            // Top 3 멤버 표시
            topMembersDisplay.innerHTML = '';
            for (let i = 0; i < Math.min(3, sortedMembers.length); i++) {
                const member = sortedMembers[i];
                const rank = i + 1;
                const card = document.createElement('div');
                card.classList.add('top-member-card', `rank${rank}`);
                card.innerHTML = `
                    <div class="rank-label">${rank}위</div>
                    <img src="./images/${member.name}.png" alt="${member.name}">
                    <p>${member.name}</p>
                    <span class="score">점수: ${member.score.toFixed(1)}</span>
                `;
                topMembersDisplay.appendChild(card);
            }

            // 최종 16인 리스트 표시 (혹은 남은 멤버 모두)
            finalSelectionList.innerHTML = '';
            const finalCount = Math.min(16, sortedMembers.length);
            for (let i = 0; i < finalCount; i++) {
                const member = sortedMembers[i];
                const listItem = document.createElement('li');
                listItem.textContent = `${i + 1}위: ${member.name} (${member.score.toFixed(1)}점)`;
                finalSelectionList.appendChild(listItem);
            }
            document.getElementById('finalSelectionListTitle').textContent = `💖 최종 선발 ${finalCount}인 💖`;
        }

        // 텍스트 결과 저장 기능
        document.getElementById('downloadTextResultButton').addEventListener('click', () => {
            const sortedMembers = getSortedMembers(false);
            let textContent = "MY HKT48 선발 최종 결과\n\n";

            textContent += "--- Top 3 ---\n";
            for (let i = 0; i < Math.min(3, sortedMembers.length); i++) {
                const member = sortedMembers[i];
                textContent += `${i + 1}위: ${member.name} (${member.score.toFixed(1)}점)\n`;
            }
            textContent += "\n";

            textContent += "--- 최종 선발 16인 (혹은 남은 멤버) ---\n";
            const finalCount = Math.min(16, sortedMembers.length);
            for (let i = 0; i < finalCount; i++) {
                const member = sortedMembers[i];
                textContent += `${i + 1}위: ${member.name} (${member.score.toFixed(1)}점)\n`;
            }

            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'HKT48_Senbatsu_Results.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // 이미지 결과 저장 기능 (html2canvas 사용)
        document.getElementById('downloadImageResultButton').addEventListener('click', () => {
            html2canvas(document.querySelector('.container'), {
                useCORS: true, // 크로스 오리진 이미지 로드 허용 (필요시)
                scale: 2, // 고해상도 이미지를 위해 스케일 조정
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'HKT48_Senbatsu_Results.png';
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });


        // 게임 초기화 버튼 이벤트 리스너
        document.getElementById('resetGameButton').addEventListener('click', () => {
            if (confirm("게임을 정말 초기화하시겠습니까? 현재 진행 상황은 저장되지 않습니다.")) {
                initializeGame();
            }
        });

        // 새 게임 시작 버튼 이벤트 리스너 (결과 화면에서)
        document.getElementById('restartGameButton').addEventListener('click', () => {
            initializeGame();
        });

        // 게임 시작
        initializeGame();
    </script>
</body>
</html>
