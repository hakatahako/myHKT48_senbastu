<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        /* 바닥판 */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1160px;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        /* 멤버카드 (분홍색 판) - PC 기본 스타일 */
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 15px; /* PC 패딩 줄임 */
            width: 370px; /* 3명 배열에 맞게 조정 */
            min-width: 370px;
            flex-shrink: 0;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column; /* PC: 세로형 */
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        .member-card.processed {
            pointer-events: none;
            opacity: 0.8;
        }

        /* 멤버 사진 - PC 기본 스타일 */
        .member-card img {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px; /* PC 이미지 아래 여백 줄임 */
            transition: border-color 0.2s;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            margin-top: 20px; /* PC에서는 기존 위치 유지 */
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 30px; /* 이미지 크기 증가에 맞춰 간격 조정 */
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 30px; /* 패딩 늘림 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        /* 1위 카드 스타일 (2,3위보다 10% 더 크게) */
        .top-member-card.rank1 {
            width: calc(247.5px + 60px + 8px);
            height: auto;
            border: 4px solid #FFD700;
            background-color: #FFFACD;
            transform: translateY(-30px);
            order: 2;
        }
        .top-member-card.rank1 img {
            width: 247.5px;
            height: 247.5px;
        }

        /* 2, 3위 카드 스타일 (기준 크기) */
        .top-member-card.rank2, .top-member-card.rank3 {
            width: calc(225px + 60px + 8px);
            height: auto;
            border: 4px solid #C0C0C0;
            background-color: #E0E0E0;
            order: 1;
        }
        .top-member-card.rank3 {
            border: 4px solid #CD7F32;
            background-color: #D2B48C;
            order: 3;
        }
        .top-member-card.rank2 img, .top-member-card.rank3 img {
            width: 225px;
            height: 225px;
        }

        .top-member-card img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }
        .top-member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
            display: none; /* 점수 표시 비활성화 */
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .restart-button-group button {
            width: 250px;
        }
        /* 동점자 라운드 시 표시될 안내 텍스트 스타일 (이제 사용 안 함) */
        .tie-breaker-info {
            font-weight: bold;
            color: #ad1457;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: none !important; /* 이 요소를 완전히 숨김 */
        }

        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* ----- 새로 추가된 CSS ----- */
        #rulesScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        #rulesScreen .rules-box {
            border: 2px solid #ffccbc;
            border-radius: 10px;
            padding: 20px;
            background-color: #ffebee;
            max-width: 600px;
            text-align: left;
        }
        #rulesScreen .rules-box p {
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        #rulesScreen button {
            background-color: #ad1457;
            color: white;
        }
        #rulesScreen button:hover {
            background-color: #920b4a;
        }

        #finalSelectionDisplay {
            display: none; /* 초기에는 숨김 */
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: center;
        }
        #finalSelectionDisplay h2 {
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .selected-16-members {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px; /* 16명을 위한 작은 간격 */
            margin-bottom: 30px;
        }
        .selected-16-member-card {
            border: 1px solid #ffccbc;
            border-radius: 8px;
            padding: 5px;
            text-align: center;
            width: 120px; /* 16명 표시를 위한 작은 카드 크기 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #ffebee;
        }
        .selected-16-member-card img {
            width: 100px; /* 이미지 크기 */
            height: 100px; /* 이미지 크기 */
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
        }
        .selected-16-member-card p {
            font-size: 0.9em;
            font-weight: bold;
            color: #ad1457;
            margin: 0;
        }

        #startCenterSelectionButton {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
            margin-top: 20px;
        }
        #startCenterSelectionButton:hover {
            background-color: #45a049;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                max-width: 95%;
            }
            h1 {
                font-size: 1.8em;
            }
            /* 모바일에서 라운드 정보와 '3명 중 좋아하는 순서대로 2명을 선택하세요!' 문구 숨김 */
            .round-info, h2 {
                display: none;
            }
            /* 모바일 상단 안내 글자 간략화 및 크기 조정 */
            #instructionText {
                font-size: 0.9em;
                margin-top: 0;
                margin-bottom: 15px;
            }
            /* .tie-breaker-info 는 위에서 !important로 완전히 숨김 */

            .member-display {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-top: 15px;
            }
            /* 멤버카드 - 모바일: 가로형 */
            .member-card {
                width: 95%;
                max-width: 350px;
                min-width: unset;
                padding: 8px 10px;
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
                gap: 8px;
            }
            .member-card:hover {
                transform: none;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            }
            .member-card.selected {
                transform: none;
            }

            /* 멤버 사진 - 모바일: 크기 20% 더 키움 */
            .member-card img {
                width: 72px; /* 60px * 1.2 = 72px */
                height: 72px; /* 60px * 1.2 = 72px */
                border-radius: 50%;
                object-fit: cover;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            .member-card p {
                font-size: 1.1em;
                text-align: left;
                flex-grow: 1;
            }
            .selection-rank {
                top: 50%;
                left: unset;
                right: 8px;
                transform: translateY(-50%);
                width: 25px;
                height: 25px;
                font-size: 0.9em;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
            button {
                width: 90%;
                padding: 12px 20px;
                font-size: 1.1em;
            }
            /* 게임 초기화 버튼 모바일 스타일 변경 */
            #resetGameButton {
                width: 120px; /* 더 작게 */
                padding: 8px 15px; /* 패딩도 줄임 */
                font-size: 0.9em; /* 폰트도 작게 */
                margin-top: 0; /* 상단 마진 제거 */
                align-self: center; /* 가운데 정렬 */
                order: 10; /* 다른 버튼보다 아래로 내림 */
            }

            .top-members {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%;
                transform: none !important;
                order: initial !important;
            }
            .top-member-card.rank1 img {
                width: 180px;
                height: 180px;
            }
            .top-member-card.rank2 img, .top-member-card.rank3 img {
                width: 150px;
                height: 150px;
            }
            .restart-button-group button {
                width: 90%;
            }

            /* 2페이즈 16명 카드 모바일 */
            .selected-16-member-card {
                width: 80px; /* 더 작게 */
                padding: 3px;
            }
            .selected-16-member-card img {
                width: 70px;
                height: 70px;
            }
            .selected-16-member-card p {
                font-size: 0.7em;
            }
            #startCenterSelectionButton {
                width: 90%;
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>

        <div id="rulesScreen">
            <div class="rules-box">
                <p>1페이즈 (16인 선발전): HKT48 멤버들 중 당신만의 최종 선발 16인을 뽑습니다.</p>
                <p>2페이즈 (센터 선발전): 최종 선발된 16인 중 당신의 센터를 결정합니다.</p>
                <br>
                <p style="font-size:0.9em; color:#888;">* </p>
            </div>
            <button id="startGameButton">게임 시작</button>
        </div>

        <div id="gameScreen" style="display: none;">
            <p id="instructionText" style="font-weight: bold; color: #ad1457;"></p>
            <div class="round-info">
                <span id="currentRound"></span>
            </div>
            <h2>3명 중 좋아하는 순서대로 2명을 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
            </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <div id="finalSelectionDisplay" style="display: none;">
            <h2>MY HKT48 최종 선발 16인</h2>
            <div class="selected-16-members" id="selected16MembersDisplay">
                </div>
            <button id="startCenterSelectionButton">센터 선발전 시작</button>
        </div>

        <div id="resultsScreen" class="results-screen">
            <h2 id="resultsScreenTitle">🎉 최종 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
            </div>
            <div class="final-selection-list">
                <h3 id="finalSelectionListTitle">💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                </ul>
            </div>
            <div class="restart-button-group">
                <button id="downloadTextResultButton">결과 저장 (텍스트)</button>
                <button id="downloadImageResultButton">결과 저장 (이미지)</button>
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카", "야나세 레이아", "야마우치 유나", "야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우에 네네", "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        let memberData = {};
        let currentRound = 0;
        // 게임 페이즈: 'rules' (시작 화면), 'phase1' (16인 선발), 'phase2' (최종 순위 결정), 'results'
        let gamePhase = 'rules';
        let selectionOrder = []; // 현재 라운드에서 선택된 멤버들의 이름 (순서대로)
        let availableMembersForRound = []; // 현재 라운드에 표시될 멤버들
        let selected16Members = []; // 1페이즈에서 최종 선발된 16명 멤버 이름 목록

        const maxAppearancesPhase1 = 4; // 1페이즈 한 멤버는 최대 4회 등장 (완화된 규칙)
        const maxAppearancesPhase2 = 6; // 2페이즈 한 멤버는 최대 6회 등장 (완화된 규칙)

        const membersPerRound = 3; // 라운드당 보여주는 멤버 3명
        const initialSelectionTarget = 16; // 1차 선발 목표 인원

        // 점수 정의
        const scores = {
            rank1: 10, // 1순위: 10점
            rank2: 4,  // 2순위: 4점
            rank3: 0   // 3순위 (선택 없음): 0점
        };

        const instructionTextElement = document.getElementById('instructionText');
        const currentRoundElement = document.getElementById('currentRound');
        const memberSelectionDiv = document.getElementById('memberSelection');
        const rulesScreen = document.getElementById('rulesScreen');
        const gameScreen = document.getElementById('gameScreen');
        const finalSelectionDisplay = document.getElementById('finalSelectionDisplay');
        const selected16MembersDisplay = document.getElementById('selected16MembersDisplay');
        const startCenterSelectionButton = document.getElementById('startCenterSelectionButton');
        const resultsScreen = document.getElementById('resultsScreen');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');

        document.getElementById('startGameButton').addEventListener('click', () => {
            initializeGame();
            gamePhase = 'phase1';
            rulesScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            startNewRound();
        });

        document.getElementById('resetGameButton').addEventListener('click', () => {
            if (confirm("정말 게임을 초기화하시겠습니까? 현재 진행 상황은 모두 사라집니다.")) {
                location.reload(); 
            }
        });

        document.getElementById('restartGameButton').addEventListener('click', () => {
            location.reload(); 
        });

        document.getElementById('downloadTextResultButton').addEventListener('click', downloadTextResult);
        document.getElementById('downloadImageResultButton').addEventListener('click', downloadImageResult);

        // 2페이즈 시작 버튼 이벤트 리스너
        startCenterSelectionButton.addEventListener('click', () => {
            gamePhase = 'phase2';
            finalSelectionDisplay.style.display = 'none';
            gameScreen.style.display = 'block';
            // 2페이즈 시작 시 16인 멤버의 appearedInPhase2를 모두 false로 초기화 (새로운 페이즈 시작)
            selected16Members.forEach(name => {
                memberData[name].appearedInPhase2 = false;
                memberData[name].appearances = 0; // 2페이즈에서는 등장 횟수 재시작
            });
            startNewRound();
        });


        function initializeGame() {
            memberData = {};
            memberNames.forEach(name => {
                memberData[name] = {
                    score: 0,
                    appearances: 0,
                    zeroScoreCount: 0, // 0점 받은 횟수 (1페이즈 탈락 조건용)
                    eliminated: false, // 1페이즈 탈락 여부
                    previousRoundTrios: new Set(), // 이전 라운드에 함께 등장했던 3인 조합 기록 (Set of stringified arrays)
                    appearedInPhase2: false // 2페이즈에서 등장했는지 여부
                };
            });
            currentRound = 0;
            selectionOrder = [];
            availableMembersForRound = [];
            selected16Members = []; // 초기화

            // 화면 초기 상태 설정
            rulesScreen.style.display = 'flex';
            gameScreen.style.display = 'none';
            finalSelectionDisplay.style.display = 'none';
            resultsScreen.style.display = 'none';
            updateInstructionText();
        }

        // --- 안내 메시지 간소화 (페이즈당 1줄) ---
        function updateInstructionText() {
            const nonEliminatedCount = Object.values(memberData).filter(m => !m.eliminated).length;
            if (gamePhase === 'rules') {
                instructionTextElement.textContent = ''; 
                document.querySelector('#gameScreen h2').style.display = 'none'; 
            } else if (gamePhase === 'phase1') {
                instructionTextElement.textContent = `1페이즈: 현재 인원 ${nonEliminatedCount}명, 최종 선발 16인을 뽑고 있습니다.`;
                document.querySelector('#gameScreen h2').style.display = 'block';
            } else if (gamePhase === 'phase2') {
                instructionTextElement.textContent = `2페이즈: 최종 선발 16인의 센터 순위 경쟁 중입니다.`;
                document.querySelector('#gameScreen h2').style.display = 'block';
            } else if (gamePhase === 'results') {
                instructionTextElement.textContent = `게임이 종료되었습니다! 최종 결과를 확인하세요.`;
                document.querySelector('#gameScreen h2').style.display = 'none';
            }
            // 모바일에서 h2 숨김 처리를 위해 round-info도 함께 업데이트 필요
            if (window.innerWidth <= 768) {
                document.querySelector('.round-info').style.display = (gamePhase === 'phase1' || gamePhase === 'phase2') ? 'none' : 'block';
                document.querySelector('#gameScreen h2').style.display = 'none'; // 모바일에서는 아예 숨김
            } else {
                document.querySelector('.round-info').style.display = 'block';
                document.querySelector('#gameScreen h2').style.display = 'block';
            }
        }

        function getEligibleMembersForRound(forStrictModeCheck = false) {
            let currentMaxAppearancesLimit;
            if (gamePhase === 'phase1') {
                currentMaxAppearancesLimit = maxAppearancesPhase1; // 1페이즈는 최대 4회 등장
            } else if (gamePhase === 'phase2') {
                currentMaxAppearancesLimit = maxAppearancesPhase2; // 2페이즈는 최대 6회 등장
            }

            let eligible = [];
            if (gamePhase === 'phase1') {
                eligible = Object.keys(memberData).filter(name => 
                    !memberData[name].eliminated && memberData[name].appearances < currentMaxAppearancesLimit
                );
            } else if (gamePhase === 'phase2') {
                // 2페이즈에서는 selected16Members 목록에 있는 멤버만 대상으로 함 (탈락 규칙 없음)
                let baseEligible = selected16Members.filter(name => true); // 2페이즈에서는 eliminated 조건 무시

                // StrictModeCheck (새로운 3인 조합 찾기)를 위해 등장 횟수 제한만 적용
                if (forStrictModeCheck) {
                    eligible = baseEligible.filter(name => memberData[name].appearances < currentMaxAppearancesLimit);
                } else {
                    // 2페이즈 등장 균등화 로직
                    // 1. 아직 등장하지 않은 멤버 우선
                    const notYetAppearedInPhase2 = baseEligible.filter(name => 
                        !memberData[name].appearedInPhase2 && memberData[name].appearances < currentMaxAppearancesLimit
                    );
                    if (notYetAppearedInPhase2.length >= membersPerRound) {
                        eligible = notYetAppearedInPhase2;
                    } else {
                        // 2. 모든 16인이 한 번 이상 등장했다면, 등장 횟수가 가장 적은 멤버들 우선
                        //    그리고 여전히 등장 횟수 제한을 지키는 멤버들
                        const sortedByAppearances = baseEligible.sort((a, b) => 
                            memberData[a].appearances - memberData[b].appearances
                        );
                        eligible = sortedByAppearances.filter(name => memberData[name].appearances < currentMaxAppearancesLimit);
                    }
                }
            }
            return eligible;
        }

        // 특정 트리오가 이미 등장했는지 확인하는 헬퍼 함수
        function hasTrioAppearedBefore(trio) {
            const sortedTrio = [...trio].sort();
            const trioString = sortedTrio.join(',');
            
            return sortedTrio.some(name => memberData[name].previousRoundTrios.has(trioString));
        }

        function selectMembersForRound() {
            let selected = [];
            let eligiblePool = getEligibleMembersForRound(true); // 등장 횟수 제한 준수 풀
            
            // 시도 1: 등장 횟수 제한 + 3인 조합 중복 불가 규칙 준수
            let potentialCombinations = [];
            if (eligiblePool.length >= membersPerRound) {
                for (let i = 0; i < eligiblePool.length; i++) {
                    for (let j = i + 1; j < eligiblePool.length; j++) {
                        for (let k = j + 1; k < eligiblePool.length; k++) {
                            const trio = [eligiblePool[i], eligiblePool[j], eligiblePool[k]];
                            if (!hasTrioAppearedBefore(trio)) {
                                potentialCombinations.push(trio);
                            }
                        }
                    }
                }
            }

            if (potentialCombinations.length > 0) {
                selected = potentialCombinations[Math.floor(Math.random() * potentialCombinations.length)];
                console.log(`[Round ${currentRound}] Selected: Strict combination found.`);
            } else {
                // 시도 2: 3인 조합 중복 불가 규칙 완화 (랜덤 3인)
                console.warn(`[Round ${currentRound}] No strict trio found. Attempting to relax 3-member combo rule.`);
                
                // 등장 횟수 제한 내의 멤버들 중 무작위 3인 선택
                const shuffledEligible = eligiblePool.sort(() => 0.5 - Math.random());
                selected = shuffledEligible.slice(0, membersPerRound);

                if (selected.length < membersPerRound) {
                    console.error(`[Round ${currentRound}] Critical error: Could not select enough members (${selected.length}) even after all relaxations. Game cannot continue.`);
                    alert("더 이상 라운드를 진행할 수 있는 멤버가 부족합니다. 게임을 종료합니다.");
                    gamePhase = 'results'; 
                    displayResults();
                    return;
                }
                console.log(`[Round ${currentRound}] Selected: Relaxed combination or appearance limit applied. Members: ${selected.join(', ')}`);
            }

            availableMembersForRound = selected;
            renderMembers();
        }


        function startNewRound() {
            currentRound++;
            currentRoundElement.textContent = currentRound + " 라운드";
            selectionOrder = []; // 새 라운드 시작 시 선택 순서 초기화
            memberSelectionDiv.innerHTML = ''; // 이전 멤버 카드 제거

            updateInstructionText();

            // 게임 페이즈 전환 로직 및 종료 조건 확인
            const nonEliminatedMembers = Object.values(memberData).filter(m => !m.eliminated);
            const nonEliminatedCount = nonEliminatedMembers.length;

            if (gamePhase === 'phase1') {
                // 1페이즈 중단 방지 로직: 탈락하지 않은 모든 멤버가 최소 3회 이상 등장했는지 확인
                const allNonEliminatedAppearedEnough = nonEliminatedMembers.every(m => m.appearances >= 3);

                if (allNonEliminatedAppearedEnough) {
                    console.log("Phase 1 auto-advance: All non-eliminated members appeared at least 3 times.");
                    gamePhase = 'finalSelectionDisplay'; // 2페이즈 시작 전 중간 화면
                    selected16Members = getSortedMembers(false) // 탈락자 제외하고 현재 점수 기준으로 정렬
                                            .slice(0, initialSelectionTarget) // 상위 16명만 선택
                                            .map(m => m.name); // 이름만 추출
                    // 16명을 제외한 나머지 멤버들은 'eliminated' 처리
                    Object.keys(memberData).forEach(name => {
                        if (!selected16Members.includes(name)) {
                            memberData[name].eliminated = true;
                        }
                    });
                    displayFinalSelectionScreen();
                    return;
                }
                
                // 기존 1페이즈 종료 조건: 탈락하지 않은 멤버가 16명 이하가 되면 종료
                if (nonEliminatedCount <= initialSelectionTarget) {
                    console.log("Phase 1 complete: Non-eliminated members count <= 16.");
                    gamePhase = 'finalSelectionDisplay'; // 2페이즈 시작 전 중간 화면
                    selected16Members = Object.keys(memberData)
                                            .filter(name => !memberData[name].eliminated)
                                            .sort((a, b) => memberData[b].score - memberData[a].score)
                                            .slice(0, initialSelectionTarget); // 혹시 16명보다 많을 경우를 대비해 slice
                    displayFinalSelectionScreen();
                    return;
                }
            } else if (gamePhase === 'phase2') {
                if (checkFinalConditions()) {
                    // 2페이즈 종료 조건 만족
                    gamePhase = 'results';
                    displayResults();
                    return;
                }
            }

            // 모든 멤버가 등장 횟수 제한에 걸리거나, 남은 멤버가 3명 미만이면 게임 종료 (비상 탈출)
            // 가장 완화된 조건(등장 횟수 6회까지)으로도 3명을 뽑을 수 없다면 게임 종료
            const canStillPlay = getEligibleMembersForRound(true).length >= membersPerRound; 
            if (!canStillPlay) {
                alert("더 이상 라운드를 진행할 수 있는 멤버가 부족하여 게임을 종료합니다.");
                gamePhase = 'results';
                displayResults();
                return;
            }

            selectMembersForRound();
        }

        function renderMembers() {
            memberSelectionDiv.innerHTML = '';
            availableMembersForRound.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <img src="./images/${name}.png" alt="${name}" onerror="this.onerror=null; this.src='./images/default.png';">
                    <p>${name}</p>
                    <div class="selection-rank"></div>
                `;
                card.addEventListener('click', handleCardClick);
                memberSelectionDiv.appendChild(card);
            });
        }

        function handleCardClick(event) {
            const clickedCard = event.currentTarget;
            const clickedMemberName = clickedCard.dataset.name;

            if (clickedCard.classList.contains('processed')) {
                return; // 이미 처리된 카드는 클릭 무시
            }

            // 선택 취소 로직 (가장 마지막에 선택된 것만 취소)
            const indexInSelection = selectionOrder.indexOf(clickedMemberName);
            if (indexInSelection !== -1) {
                if (indexInSelection === selectionOrder.length - 1) { // 마지막 선택 멤버인 경우에만 취소
                    selectionOrder.pop();
                    clickedCard.classList.remove('selected');
                    clickedCard.querySelector('.selection-rank').textContent = '';
                }
                return;
            }

            const maxDirectSelections = 2; // 1순위, 2순위만 직접 선택

            if (selectionOrder.length < maxDirectSelections) {
                selectionOrder.push(clickedMemberName);
                clickedCard.classList.add('selected');
                clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length; // 1순위:1, 2순위:2

                if (selectionOrder.length === maxDirectSelections) {
                    // 모든 직접 선택이 완료되면 다음 단계 진행 (자동 선택 및 점수 적용)
                    applyScoresAndProceed();
                }
            }
        }

        function applyScoresAndProceed() {
            const currentRoundMembers = availableMembersForRound; // 현재 라운드에 나온 모든 멤버

            // 모든 카드 클릭 비활성화
            document.querySelectorAll('.member-card').forEach(card => card.classList.add('processed'));

            // 3순위 자동 선택 (선택되지 않은 1명)
            const unselectedMember = currentRoundMembers.find(name => !selectionOrder.includes(name));
            if (unselectedMember) {
                selectionOrder.push(unselectedMember); // 3순위로 자동 추가
                const unselectedCard = document.querySelector(`.member-card[data-name="${unselectedMember}"]`);
                if (unselectedCard) {
                    unselectedCard.classList.add('selected'); // 3순위도 선택된 것으로 표시
                    unselectedCard.querySelector('.selection-rank').textContent = '3';
                }
            }

            // 점수 부여 및 기타 데이터 업데이트
            currentRoundMembers.forEach(name => {
                const rankIndex = selectionOrder.indexOf(name); // selectionOrder는 0(1순위), 1(2순위), 2(3순위)
                let scoreToApply = 0;

                if (rankIndex === 0) scoreToApply = scores.rank1;
                else if (rankIndex === 1) scoreToApply = scores.rank2;
                else if (rankIndex === 2) scoreToApply = scores.rank3; 
                
                memberData[name].score += scoreToApply;

                // --- 0점 처리 (1페이즈 탈락 조건용) - 2페이즈에서는 작동 안함 ---
                if (gamePhase === 'phase1' && scoreToApply === 0) {
                    memberData[name].zeroScoreCount++;
                    if (memberData[name].zeroScoreCount >= 3) {
                        memberData[name].eliminated = true; 
                        console.log(`${name} 님이 0점을 3회 받아 1페이즈에서 탈락했습니다.`);
                    }
                }

                // 2페이즈에서 등장했는지 여부 기록
                if (gamePhase === 'phase2') {
                    memberData[name].appearedInPhase2 = true;
                }

                // 등장 횟수 증가
                memberData[name].appearances++;
            });

            // "같은 3인 조합은 두 번 다시 등장하지 않음" 규칙을 위한 기록
            // 현재 라운드의 3인 조합을 정규화하여 Set에 저장
            const currentTrio = [...availableMembersForRound].sort().join(',');
            availableMembersForRound.forEach(name => {
                memberData[name].previousRoundTrios.add(currentTrio);
            });
            
            // 딜레이 없이 바로 다음 라운드 시작
            startNewRound();
        }

        function displayFinalSelectionScreen() {
            gameScreen.style.display = 'none';
            finalSelectionDisplay.style.display = 'block';
            selected16MembersDisplay.innerHTML = '';

            // 16인 멤버를 점수순으로 정렬하여 표시
            const sortedFinal16 = selected16Members.map(name => ({
                name: name,
                score: memberData[name].score
            })).sort((a, b) => b.score - a.score); // 점수 내림차순

            sortedFinal16.forEach(member => {
                const card = document.createElement('div');
                card.classList.add('selected-16-member-card');
                card.innerHTML = `
                    <img src="./images/${member.name}.png" alt="${member.name}" onerror="this.onerror=null; this.src='./images/default.png';">
                    <p>${member.name}</p>
                `;
                selected16MembersDisplay.appendChild(card);
            });
        }

        function getSortedMembers(includeEliminated = false) {
            let sortable = [];
            for (let name in memberData) {
                if (includeEliminated || !memberData[name].eliminated) {
                    sortable.push({
                        name: name,
                        score: memberData[name].score
                    });
                }
            }
            // 점수가 높은 순으로 정렬. 점수가 같으면 이름(사전순)으로 정렬 (동점 시 일관성 유지)
            sortable.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return a.name.localeCompare(b.name);
            });
            return sortable;
        }

        function checkFinalConditions() {
            const sortedMembers = getSortedMembers(false); // 탈락자 제외 (2페이즈에서는 탈락 없음)

            // 16인 미만이면 아직 종료 조건 체크 대상 아님
            if (sortedMembers.length < initialSelectionTarget) {
                 return false;
            }

            const top16 = sortedMembers.slice(0, initialSelectionTarget);

            // 1위, 2위, 3위는 공동 순위 불가 (점수 차이 확인)
            if (top16.length >= 2 && top16[0].score === top16[1].score) {
                 console.log("Final check fail: 공동 1위"); return false;
            }
            if (top16.length >= 3 && top16[1].score === top16[2].score) {
                 console.log("Final check fail: 공동 2위"); return false;
            }
            if (top16.length >= 4 && top16[2].score === top16[3].score) {
                 console.log("Final check fail: 공동 3위"); return false;
            }

            // 1위와 16위의 점수 차이 최소 40점 이상
            if (top16.length >= initialSelectionTarget && (top16[0].score - top16[initialSelectionTarget - 1].score < 40)) {
                console.log("Final check fail: 1위-16위 점수차 40점 미만"); return false;
            }

            // 공동 순위가 3명 이상인 경우가 없어야 함 (4위부터 16위까지)
            // 동점자가 3명 이상인 경우 확인
            for (let i = 3; i < top16.length; i++) { 
                let currentScore = top16[i].score;
                let count = 0;
                for (let j = i; j < top16.length; j++) {
                    if (top16[j].score === currentScore) {
                        count++;
                    } else {
                        break;
                    }
                }
                if (count >= 3) {
                    console.log(`Final check fail: 공동 순위 3명 이상 발견 (순위 ${i+1}부터), 점수: ${currentScore}`);
                    return false;
                }
                i += (count - 1); // 이미 확인한 동점자는 건너뛰기
            }


            // 모든 16인 멤버가 2페이즈에서 최소 한 번씩은 등장했는지 확인
            const allAppearedInPhase2 = selected16Members.every(name => memberData[name].appearedInPhase2);
            if (!allAppearedInPhase2) {
                console.log("Final check fail: 모든 멤버가 2페이즈에서 최소 한 번 등장하지 않음"); return false;
            }

            console.log("Final check success: All conditions met.");
            return true; // 모든 조건 만족
        }


        function displayResults() {
            gameScreen.style.display = 'none';
            finalSelectionDisplay.style.display = 'none';
            resultsScreen.style.display = 'block';

            const sortedMembers = getSortedMembers(false); // 탈락자 제외

            // 최종 3인 표시
            topMembersDisplay.innerHTML = '';
            if (sortedMembers.length > 0) {
                const top3 = sortedMembers.slice(0, 3);
                top3.forEach((member, index) => {
                    const rank = index + 1;
                    const card = document.createElement('div');
                    card.classList.add('top-member-card', `rank${rank}`);
                    card.innerHTML = `
                        <div class="rank-label">${rank}위</div>
                        <img src="./images/${member.name}.png" alt="${member.name}" onerror="this.onerror=null; this.src='./images/default.png';">
                        <p>${member.name}</p>
                        <span class="score" style="display:none;">${member.score}점</span>
                    `;
                    topMembersDisplay.appendChild(card);
                });
            }

            // 최종 선발 16인 목록 표시
            finalSelectionList.innerHTML = '';
            const final16 = sortedMembers.slice(0, initialSelectionTarget);
            final16.forEach((member, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${index + 1}위: ${member.name} (${member.score}점)`;
                finalSelectionList.appendChild(listItem);
            });
        }

        function downloadTextResult() {
            const sortedMembers = getSortedMembers(false);
            let resultText = "--- MY HKT48 선발 결과 ---\n\n";

            resultText += "👑 최종 센터 3인 👑\n";
            const top3 = sortedMembers.slice(0, 3);
            if (top3.length > 0) {
                top3.forEach((member, index) => {
                    resultText += `${index + 1}위: ${member.name} (${member.score}점)\n`;
                });
            } else {
                resultText += "선발된 멤버가 없습니다.\n";
            }
            resultText += "\n";

            resultText += "💖 최종 선발 16인 💖\n";
            const final16 = sortedMembers.slice(0, initialSelectionTarget);
            if (final16.length > 0) {
                final16.forEach((member, index) => {
                    resultText += `${index + 1}위: ${member.name} (${member.score}점)\n`;
                });
            } else {
                resultText += "선발된 멤버가 없습니다.\n";
            }
            resultText += "\n--- 게임 종료 ---\n";

            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'MY_HKT48_선발결과.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadImageResult() {
            // 결과를 보여주는 resultsScreen 요소를 캡처
            html2canvas(document.querySelector('.container'), {
                scale: 2, // 고해상도 이미지
                useCORS: true, // 외부 이미지 로드를 위해 필요
                allowTaint: true // cross-origin 이미지 허용
            }).then(canvas => {
                // 캡처된 캔버스를 이미지 URL로 변환
                const image = canvas.toDataURL('image/png');

                // 다운로드 링크 생성
                const link = document.createElement('a');
                link.href = image;
                link.download = 'MY_HKT48_선발결과.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(error => {
                console.error('이미지 저장 중 오류 발생:', error);
                alert('이미지 저장에 실패했습니다. 브라우저 설정을 확인해주세요.');
            });
        }

        // 게임 시작 시 초기화
        initializeGame();
    </script>
</body>
</html>
