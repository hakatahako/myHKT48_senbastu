<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
        }
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 20px;
            width: 200px; /* 카드 크기 고정 (내부 이미지 크기 조절) */
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        /* 선택 완료 시 금은동 구분 스타일은 제거 */
        .member-card.processed { /* 선택 완료된 카드에만 적용 */
            pointer-events: none; /* 클릭 비활성화 */
            opacity: 0.8; /* 약간 투명하게 */
        }


        .member-card img {
            width: 360px; /* 이미지 크기 2배 추가 확대 */
            height: 360px; /* 이미지 크기 2배 추가 확대 */
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 4px solid #ad1457;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s;
        }
        .member-card.selected img {
             border-color: #ff5252;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #startGameButton {
            background-color: #4CAF50;
            color: white;
            /* 하단 가운데 배치 */
            margin-top: 40px; /* 기존 컨텐츠와 분리 */
            position: relative; /* relative로 변경하여 flexbox나 block 흐름을 따르도록 */
            display: block; /* 가운데 정렬을 위해 block 요소로 */
            margin-left: auto; /* 자동 마진으로 가운데 정렬 */
            margin-right: auto; /* 자동 마진으로 가운데 정렬 */
        }
        #startGameButton:hover {
            background-color: #43A047;
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            display: none;
            margin-top: 20px;
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            width: 200px;
            box-sizing: border-box;
            position: relative;
        }
        .top-member-card.rank1 { border: 4px solid #FFD700; background-color: #FFFACD; }
        .top-member-card.rank2 { border: 4px solid #C0C0C0; background-color: #E0E0E0; }
        .top-member-card.rank3 { border: 4px solid #CD7F32; background-color: #D2B48C; }

        .top-member-card img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid #ad1457;
        }
        .top-member-card p {
            font-size: 1.4em;
            font-weight: bold;
            color: #ad1457;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            .member-display {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .member-card {
                width: 90%;
                max-width: 250px;
            }
            .member-card img {
                width: 150px; /* 모바일에서는 이미지 크기 조정 */
                height: 150px;
            }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 90%;
            }
            .top-members {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%;
            }
            #startGameButton {
                position: static;
                transform: none;
                width: 90%;
                margin: 20px auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>
        <p>당신의 선택으로 HKT48 <b>16인 선발 멤버</b>를 뽑아주세요!</p>
        <p id="instructionText" style="font-weight: bold; color: #ad1457;">3인의 멤버를 좋아하는 순서대로 선택해주세요. 1,2위가 결정되면 3위는 자동선택됩니다.</p>

        <div id="gameScreen">
            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2>오늘의 멤버를 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
                </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <button id="startGameButton">게임 시작</button>

        <div id="resultsScreen" class="results-screen">
            <h2>🎉 16인 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
                </div>
            <div class="final-selection-list">
                <h3>💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                    </ul>
            </div>
            <div class="restart-button-group">
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이시하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우네 네네", "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        const memberData = {}; // 이제 객체 리터럴로 초기화
        memberNames.forEach(name => {
            memberData[name] = { score: 0, appearances: 0, thirdPlaceCount: 0, eliminated: false }; // 올바른 접근 방식
        });

        let currentRound = 0;
        const membersPerRound = 3;
        let selectionOrder = [];
        let playedCombinations = new Set();
        let roundTimeout;

        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const currentRoundSpan = document.getElementById('currentRound');
        const memberSelectionDiv = document.getElementById('memberSelection');
        const startGameButton = document.getElementById('startGameButton');
        const resetGameButton = document.getElementById('resetGameButton');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const restartGameButton = document.getElementById('restartGameButton');
        const instructionText = document.getElementById('instructionText'); // 새로운 설명 문구 요소

        startGameButton.addEventListener('click', initializeGame);
        resetGameButton.addEventListener('click', initializeGame);
        restartGameButton.addEventListener('click', initializeGame);

        function initializeGame() {
            // memberData 객체 전체를 재생성하여 초기화
            for (const name of memberNames) {
                memberData[name] = { score: 0, appearances: 0, thirdPlaceCount: 0, eliminated: false };
            }
            currentRound = 0;
            playedCombinations = new Set();
            clearTimeout(roundTimeout);

            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            startGameButton.style.display = 'none';
            resetGameButton.style.display = 'block';
            instructionText.style.display = 'block'; // 게임 중에도 설명을 볼 수 있도록

            startNextRound();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // 배열 구조 분해 할당 수정
            }
            return array;
        }

        function getCandidateMembersForRound() {
            // memberData[name]으로 올바르게 접근
            return memberNames.filter(name => memberData[name].appearances < 3 && !memberData[name].eliminated);
        }

        function getUniqueRoundMembers() {
            const candidates = getCandidateMembersForRound();
            
            // 모든 멤버가 탈락하거나, 남은 멤버 수가 부족할 경우 게임 종료
            if (candidates.length < membersPerRound && memberNames.filter(name => !memberData[name].eliminated).length < membersPerRound) {
                endGame();
                return []; // 빈 배열 반환하여 다음 라운드 진행 중지
            }

            // 남은 후보가 3명 미만일 경우 (탈락자 포함)
            if (candidates.length < membersPerRound) {
                const fallbackCandidates = memberNames.filter(name => !memberData[name].eliminated)
                    .sort((a, b) => memberData[a].appearances - memberData[b].appearances);
                console.warn("경고: 남은 멤버가 부족하여 등장 횟수 제한을 완화하여 멤버를 선택합니다.");
                // 전체 멤버가 3명 미만이면 게임 종료 로직으로 보낼 수 있도록 여기에 추가 확인 필요
                if (fallbackCandidates.length < membersPerRound) {
                    endGame();
                    return [];
                }
                const selectedMembers = shuffleArray(fallbackCandidates).slice(0, membersPerRound);
                // 조합 키에 추가하여 중복 방지 (완화된 규칙에서도)
                playedCombinations.add([...selectedMembers].sort().join('-'));
                return selectedMembers;
            }

            let roundMembers = [];
            let attempts = 0;
            const maxAttempts = 5000;

            while (roundMembers.length < membersPerRound && attempts < maxAttempts) {
                const potentialRound = shuffleArray([...candidates]).slice(0, membersPerRound);
                const combinationKey = [...potentialRound].sort().join('-'); // 정렬하여 조합 키 생성

                if (!playedCombinations.has(combinationKey)) {
                    roundMembers = potentialRound;
                    playedCombinations.add(combinationKey);
                }
                attempts++;
            }

            if (roundMembers.length < membersPerRound) {
                console.warn("경고: '같은 조합 2번 나오지 않음' 규칙을 준수하며 멤버를 찾기 어려워 강제로 선택합니다.");
                const sortedCandidates = candidates.sort((a, b) => memberData[a].appearances - memberData[b].appearances);
                roundMembers = sortedCandidates.slice(0, membersPerRound);
                playedCombinations.add([...roundMembers].sort().join('-'));
            }
            return roundMembers;
        }

        function startNextRound() {
            currentRound++;
            currentRoundSpan.textContent = currentRound;
            selectionOrder = [];

            const membersForThisRound = getUniqueRoundMembers();
            if (membersForThisRound.length === 0) { // getUniqueRoundMembers에서 빈 배열이 넘어오면 게임 종료 상태
                return;
            }

            const shuffledMembersForDisplay = shuffleArray(membersForThisRound);

            memberSelectionDiv.innerHTML = '';
            shuffledMembersForDisplay.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <div class="selection-rank"></div>
                    <img src="./images/${name}.png" alt="${name}">
                    <p>${name}</p>
                `;
                card.addEventListener('click', () => handleCardClick(card, name));
                memberSelectionDiv.appendChild(card);

                // 등장 횟수 업데이트
                memberData[name].appearances++; // 올바른 접근
            });
        }

        function handleCardClick(clickedCard, memberName) {
            const isAlreadySelected = selectionOrder.includes(memberName);

            if (isAlreadySelected) {
                if (selectionOrder[selectionOrder.length - 1] === memberName) {
                    clickedCard.classList.remove('selected');
                    clickedCard.querySelector('.selection-rank').textContent = '';
                    selectionOrder.pop();
                    updateSelectionRanks();
                } else {
                    alert("가장 마지막에 선택한 멤버부터 해제할 수 있습니다.");
                }
            } else {
                if (selectionOrder.length < 2) { // 2명까지만 직접 선택
                    clickedCard.classList.add('selected');
                    selectionOrder.push(memberName);
                    clickedCard.querySelector('.selection-rank').textContent = selectionOrder.length;
                } else {
                    alert("1위와 2위 두 명의 멤버를 선택했습니다. 3위는 자동으로 결정됩니다.");
                    return; // 3번째 선택 방지
                }
            }

            // 2명의 멤버가 선택되면 3위 자동 처리 및 다음 라운드 진행
            if (selectionOrder.length === 2) {
                // 3위 멤버 자동 선택
                const remainingCard = document.querySelector(`.member-card:not(.selected)`);
                if (remainingCard) {
                    const thirdPlaceName = remainingCard.dataset.name;
                    selectionOrder.push(thirdPlaceName); // 3위 멤버를 selectionOrder에 추가
                }

                // 모든 카드 클릭 비활성화 (선택 완료 후)
                document.querySelectorAll('.member-card').forEach(card => {
                    card.removeEventListener('click', handleCardClick);
                    card.style.cursor = 'default';
                });

                // 잠시 후에 점수 부여 및 다음 라운드 진행
                setTimeout(() => {
                    applyScoresAndProceed();
                }, 800); // 0.8초 딜레이 후 다음 라운드
            }
        }

        function updateSelectionRanks() {
            document.querySelectorAll('.member-card.selected').forEach(card => {
                const memberName = card.dataset.name;
                const index = selectionOrder.indexOf(memberName);
                if (index !== -1) {
                    card.querySelector('.selection-rank').textContent = index + 1;
                }
            });
        }

        function applyScoresAndProceed() {
            // 점수 부여 (1순위 2점, 2순위 1점, 3순위 0점)
            memberData[selectionOrder[0]].score += 2;
            memberData[selectionOrder[1]].score += 1;
            // 3순위는 0점
            memberData[selectionOrder[2]].thirdPlaceCount++; // 3순위 카운트
            if (memberData[selectionOrder[2]].thirdPlaceCount >= 3) {
                memberData[selectionOrder[2]].eliminated = true;
                console.log(`${selectionOrder[2]} 멤버가 3위 3회로 탈락했습니다.`);
            }

            // 카드에 선택 완료 상태 클래스 추가 및 선택 클래스 제거
            document.querySelectorAll('.member-card').forEach(card => {
                card.classList.add('processed'); // 처리 완료된 카드
                card.classList.remove('selected'); // 선택 표시 제거
                card.querySelector('.selection-rank').textContent = ''; // 순위 숫자 제거
            });


            // 다음 라운드 시작
            roundTimeout = setTimeout(startNextRound, 1500); // 1.5초 딜레이 후 다음 라운드
        }


        function endGame() {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            resetGameButton.style.display = 'none'; // 게임 종료 시 초기화 버튼 숨김 (restart 버튼으로 대체)

            // 16인 선발 및 TOP 3 계산
            const sortedMembers = Object.entries(memberData)
                .filter(([name, data]) => !data.eliminated) // 탈락하지 않은 멤버만
                .sort(([, a], [, b]) => b.score - a.score); // 점수 기준으로 내림차순 정렬

            const finalTop16 = sortedMembers.slice(0, 16);
            const top3 = finalTop16.slice(0, 3); // 16인 중 상위 3명

            // TOP 3 표시
            topMembersDisplay.innerHTML = '';
            top3.forEach((memberArray, index) => {
                const memberName = memberArray[0];
                const data = memberArray[1];

                const card = document.createElement('div');
                card.classList.add('top-member-card');
                if (index === 0) card.classList.add('rank1');
                else if (index === 1) card.classList.add('rank2');
                else if (index === 2) card.classList.add('rank3');

                card.innerHTML = `
                    <div class="rank-label">${index + 1}위</div>
                    <img src="./images/${memberName}.png" alt="${memberName}">
                    <p>${memberName}</p>
                    <span class="score">${data.score}점</span>
                `;
                topMembersDisplay.appendChild(card);
            });

            // 16인 선발 리스트 표시
            finalSelectionList.innerHTML = '';
            finalTop16.forEach(([name, data]) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${name} (${data.score}점)`;
                finalSelectionList.appendChild(listItem);
            });
        }

        // 초기 화면 설정 (게임 시작 버튼만 보이게)
        document.addEventListener('DOMContentLoaded', () => {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
            startGameButton.style.display = 'block';
            resetGameButton.style.display = 'none';
        });
    </script>
</body>
</html>
