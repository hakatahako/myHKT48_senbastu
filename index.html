<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        /* 바닥판 */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1160px; 
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 15px; 
            margin-top: 30px;
        }
        /* 멤버카드 (분홍색 판) - PC 기본 스타일 */
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 15px; /* PC 패딩 줄임 */
            width: 370px; 
            min-width: 370px; 
            flex-shrink: 0; 
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column; /* PC: 세로형 */
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        .member-card.processed {
            pointer-events: none;
            opacity: 0.8;
        }

        /* 멤버 사진 - PC 기본 스타일 */
        .member-card img {
            width: 350px; 
            height: 350px; 
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px; /* PC 이미지 아래 여백 줄임 */
            transition: border-color 0.2s;
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            margin-top: 20px;
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center; 
            align-items: flex-end; 
            gap: 30px; /* 이미지 크기 증가에 맞춰 간격 조정 */
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 30px; /* 패딩 늘림 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        /* 1위 카드 스타일 (2,3위보다 10% 더 크게) */
        .top-member-card.rank1 {
            width: calc(247.5px + 60px + 8px); 
            height: auto; 
            border: 4px solid #FFD700; 
            background-color: #FFFACD;
            transform: translateY(-30px); 
            order: 2; 
        }
        .top-member-card.rank1 img {
            width: 247.5px; 
            height: 247.5px; 
        }

        /* 2, 3위 카드 스타일 (기준 크기) */
        .top-member-card.rank2, .top-member-card.rank3 {
            width: calc(225px + 60px + 8px); 
            height: auto; 
            border: 4px solid #C0C0C0; 
            background-color: #E0E0E0;
            order: 1; 
        }
        .top-member-card.rank3 {
            border: 4px solid #CD7F32; 
            background-color: #D2B48C;
            order: 3; 
        }
        .top-member-card.rank2 img, .top-member-card.rank3 img {
            width: 225px; 
            height: 225px; 
        }
        
        .top-member-card img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }
        .top-member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
            display: none; 
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 15px; 
        }
        .restart-button-group button {
            width: 250px; 
        }
        /* 동점자 라운드 시 표시될 안내 텍스트 스타일 */
        .tie-breaker-info {
            font-weight: bold;
            color: #ad1457;
            font-size: 1.1em;
            margin-bottom: 15px;
            animation: pulse 1.5s infinite alternate; /* 깜빡이는 효과 */
        }

        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                max-width: 95%; 
            }
            h1 {
                font-size: 1.8em;
            }
            /* 모바일에서 라운드 정보와 '오늘의 멤버' 문구 숨김 */
            .round-info, h2 {
                display: none;
            }
            /* 모바일 상단 안내 글자 간략화 및 크기 조정 */
            #instructionText {
                font-size: 0.9em; 
                margin-top: 0; 
                margin-bottom: 15px; 
            }
            .tie-breaker-info { /* 모바일에서 동점자 안내 텍스트 크기 조정 */
                font-size: 0.9em;
            }


            .member-display {
                flex-direction: column; 
                align-items: center;
                gap: 10px; 
                margin-top: 15px; 
            }
            /* 멤버카드 - 모바일: 가로형 */
            .member-card {
                width: 95%; 
                max-width: 350px; 
                min-width: unset; 
                padding: 8px 10px; 
                flex-direction: row; 
                justify-content: flex-start; 
                align-items: center;
                gap: 8px; 
            }
            .member-card:hover {
                transform: none; 
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); 
            }
            .member-card.selected {
                transform: none; 
            }

            /* 멤버 사진 - 모바일: 크기 대폭 축소 */
            .member-card img {
                width: 60px; 
                height: 60px; 
                margin-bottom: 0; 
                flex-shrink: 0; 
            }
            .member-card p {
                font-size: 1.1em; 
                text-align: left; 
                flex-grow: 1; 
            }
            .selection-rank {
                top: 50%; 
                left: unset; 
                right: 8px; 
                transform: translateY(-50%); 
                width: 25px; 
                height: 25px; 
                font-size: 0.9em; 
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px; 
            }
            button {
                width: 90%;
                padding: 12px 20px;
                font-size: 1.1em;
            }
            .top-members {
                flex-direction: column; 
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%; 
                transform: none !important; 
                order: initial !important; 
            }
            .top-member-card.rank1 img {
                width: 180px; 
                height: 180px;
            }
            .top-member-card.rank2 img, .top-member-card.rank3 img {
                width: 150px;
                height: 150px;
            }
            .restart-button-group button { 
                width: 90%; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>
        <p id="instructionText" style="font-weight: bold; color: #ad1457;"></p>
        <p id="tieBreakerInfo" class="tie-breaker-info" style="display: none;">동점자 발생! 동점자 라운드를 진행합니다.</p>

        <div id="gameScreen">
            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2>오늘의 멤버를 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
                </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <div id="resultsScreen" class="results-screen">
            <h2 id="resultsScreenTitle">🎉 최종 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
                </div>
            <div class="final-selection-list">
                <h3 id="finalSelectionListTitle">💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                    </ul>
            </div>
            <div class="restart-button-group">
                <button id="downloadTextResultButton">결과 저장 (텍스트)</button>
                <button id="downloadImageResultButton">결과 저장 (이미지)</button>
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이시하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우에 네네", 
            "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        let memberData = {}; 
        let currentRound = 0;
        const membersPerRound = 3;
        let selectionOrder = [];
        let playedCombinations = new Set(); 
        let gamePhase = 'initialSelection'; // 'initialSelection', 'finalSelection', 'tieBreakRound'
        let finalTop16Names = []; // 1차 선발에서 뽑힌 16인의 이름만 저장
        let tieBreakerMembers = []; // 동점자 라운드에 참여할 멤버들

        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const currentRoundSpan = document.getElementById('currentRound');
        const memberSelectionDiv = document.getElementById('memberSelection');
        const resetGameButton = document.getElementById('resetGameButton');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const restartGameButton = document.getElementById('restartGameButton');
        const downloadTextResultButton = document.getElementById('downloadTextResultButton'); 
        const downloadImageResultButton = document.getElementById('downloadImageResultButton'); 
        const instructionText = document.getElementById('instructionText');
        const resultsScreenTitle = document.getElementById('resultsScreenTitle');
        const finalSelectionListTitle = document.getElementById('finalSelectionListTitle');
        const tieBreakerInfo = document.getElementById('tieBreakerInfo');


        resetGameButton.addEventListener('click', initializeGame);
        restartGameButton.addEventListener('click', initializeGame);
        downloadTextResultButton.addEventListener('click', downloadTextResults); 
        downloadImageResultButton.addEventListener('click', downloadImageResults); 

        function initializeGame() {
            // 모든 멤버 데이터 초기화
            memberData = {}; 
            for (const name of memberNames) {
                // thirdPlaceCountForElimination: 3위 0점을 몇 번 받았는지 카운트 (탈락 조건용)
                memberData[name] = { score: 0, appearances: 0, thirdPlaceCountForElimination: 0, eliminated: false };
            }
            currentRound = 0;
            playedCombinations = new Set(); 
            gamePhase = 'initialSelection'; // 1차 선발 단계로 설정
            finalTop16Names = []; // 16인 멤버 초기화
            tieBreakerMembers = []; // 동점자 멤버 초기화

            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            resetGameButton.style.display = 'block';
            instructionText.style.display = 'block'; 
            tieBreakerInfo.style.display = 'none'; // 동점자 안내 숨김

            updateInstructionText(); // 안내 문구 업데이트 호출

            startNextRound();
        }

        function updateInstructionText() {
            if (window.innerWidth <= 768) { // 모바일 환경
                instructionText.textContent = '1,2위 선택 (3위 자동)';
            } else { // PC 환경
                instructionText.textContent = '3인의 멤버를 좋아하는 순서대로 선택해주세요. 1,2위가 결정되면 3위는 자동선택됩니다.';
            }
            if (gamePhase === 'tieBreakRound') {
                instructionText.style.display = 'none'; // 동점자 라운드 시 일반 안내 숨김
                tieBreakerInfo.style.display = 'block'; // 동점자 안내 표시
            } else {
                instructionText.style.display = 'block';
                tieBreakerInfo.style.display = 'none';
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; 
            }
            return array;
        }

        function getCandidateMembersForRound() {
            let candidates = [];
            let currentMembersInPlay = [];

            if (gamePhase === 'initialSelection') {
                candidates = memberNames.filter(name => memberData[name].appearances < 3 && !memberData[name].eliminated);
                
                const nonEliminatedMembers = memberNames.filter(name => !memberData[name].eliminated);
                if (nonEliminatedMembers.length <= 16 && currentRound > 0) { 
                    console.log(`잔류 멤버가 ${nonEliminatedMembers.length}명 이므로 1차 선발을 종료합니다.`);
                    endInitialSelection(); 
                    return []; 
                }
                currentMembersInPlay = candidates; // 1차 선발은 전체 후보군이 현재 플레이 대상
            } else if (gamePhase === 'finalSelection') {
                // 최종 선발에서는 16인 안에 든 멤버들만 대상으로 함
                candidates = finalTop16Names.filter(name => memberData[name].appearances < 3); 
                currentMembersInPlay = candidates;

                // 최종 선발 단계에서 더 이상 등장시킬 멤버가 없으면 결과 표시 (동점자 처리 진입점)
                if (candidates.length < membersPerRound) {
                    console.log("최종 선발 라운드: 더 이상 등장시킬 멤버가 없습니다. 최종 결과를 확인합니다.");
                    checkFinalResultsForTieBreaker(); // 동점자 확인 함수 호출
                    return []; 
                }
            } else if (gamePhase === 'tieBreakRound') {
                candidates = tieBreakerMembers; // 동점자 라운드는 동점자들만 대상으로 함
                currentMembersInPlay = candidates;

                if (candidates.length < membersPerRound) {
                    console.log("동점자 라운드: 멤버가 부족합니다. 다시 최종 결과를 확인합니다.");
                    checkFinalResultsForTieBreaker(); // 동점자 확인 함수 호출
                    return [];
                }
            }
            
            let roundMembers = [];
            let attempts = 0;
            const maxAttempts = 20000; 

            // 현재 라운드에 나올 수 있는 멤버를 필터링
            const availableCandidates = currentMembersInPlay.filter(name => memberData[name].appearances < 3);

            while (roundMembers.length < membersPerRound && attempts < maxAttempts) {
                const tempShuffle = shuffleArray([...availableCandidates]);
                const potentialRound = tempShuffle.slice(0, membersPerRound);
                
                const isValidCombination = potentialRound.every(name => {
                    // 현재 라운드에 등장할 멤버들의 appearance + 1 이 3회 이상 되는지 체크
                    return memberData[name].appearances < 3; // 3회 등장 제한
                });

                const combinationKey = [...potentialRound].sort().join('-');

                // 이미 등장한 조합인지 확인
                if (isValidCombination && !playedCombinations.has(combinationKey)) {
                    roundMembers = potentialRound;
                    playedCombinations.add(combinationKey);
                }
                attempts++;
            }

            if (roundMembers.length < membersPerRound) {
                console.warn("경고: 엄격한 규칙을 준수하며 멤버를 찾기 어려워 강제로 선택합니다.");
                const sortedCandidates = availableCandidates.sort((a, b) => memberData[a].appearances - memberData[b].appearances);
                let forcedRoundMembers = [];
            
                for(let i = 0; i < sortedCandidates.length && forcedRoundMembers.length < membersPerRound; i++) {
                    const candidateName = sortedCandidates[i];
                    if (memberData[candidateName].appearances < 3 && !forcedRoundMembers.includes(candidateName)) {
                        forcedRoundMembers.push(candidateName);
                    }
                }
                roundMembers = forcedRoundMembers.slice(0, membersPerRound);
                // 강제로 선택된 조합은 playedCombinations에 추가하지 않음 (다시 나올 수도 있도록)
            }
            return roundMembers;
        }

        function startNextRound() {
            currentRound++;
            currentRoundSpan.textContent = currentRound;
            selectionOrder = []; 

            const membersForThisRound = getCandidateMembersForRound(); 
            if (membersForThisRound.length === 0) { 
                return; // 더 이상 진행할 라운드가 없으면 함수 종료
            }

            const shuffledMembersForDisplay = shuffleArray(membersForThisRound); 

            memberSelectionDiv.innerHTML = ''; 
            shuffledMembersForDisplay.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <div class="selection-rank"></div>
                    <img src="./images/${name}.png" alt="${name}">
                    <p>${name}</p>
                `;
                card.addEventListener('click', () => handleCardClick(card, name));
                memberSelectionDiv.appendChild(card);

                memberData[name].appearances++; // 등장 횟수 증가 (tieBreakRound 포함)
            });
            updateInstructionText(); // 라운드 시작 시 안내 문구 업데이트
        }

        function handleCardClick(clickedCard, memberName) {
            const isAlreadySelected = selectionOrder.includes(memberName);

            if (isAlreadySelected) {
                if (selectionOrder[selectionOrder.length - 1] === memberName) {
                    clickedCard.classList.remove('selected');
                    const rankSpan = clickedCard.querySelector('.selection-rank');
                    if (rankSpan) rankSpan.textContent = ''; 
                    selectionOrder.pop(); 
                    
                    updateSelectionRanks();
                } else {
                    alert("선택은 가장 마지막에 클릭한 멤버부터 해제할 수 있습니다.");
                }
            } else {
                // 동점자 라운드에서는 선택 인원 제한이 달라질 수 있음. (현재는 3명 보여주고 2명 선택)
                if (selectionOrder.length < 2) { 
                    clickedCard.classList.add('selected');
                    selectionOrder.push(memberName);
                    const rankSpan = clickedCard.querySelector('.selection-rank');
                    if (rankSpan) rankSpan.textContent = selectionOrder.length; 
                } else {
                    alert("1위와 2위 두 명의 멤버를 선택했습니다. 3위는 자동으로 결정됩니다.");
                    return;
                }
            }

            if (selectionOrder.length === 2) {
                const allCurrentCards = Array.from(memberSelectionDiv.querySelectorAll('.member-card'));
                const selectedNamesInRound = selectionOrder;
                const thirdPlaceCard = allCurrentCards.find(card => !selectedNamesInRound.includes(card.dataset.name));
                
                if (thirdPlaceCard) {
                    const thirdPlaceName = thirdPlaceCard.dataset.name;
                    selectionOrder.push(thirdPlaceName); 
                    thirdPlaceCard.classList.add('selected');
                    const rankSpan = thirdPlaceCard.querySelector('.selection-rank');
                    if (rankSpan) rankSpan.textContent = selectionOrder.length; 
                }

                document.querySelectorAll('.member-card').forEach(card => {
                    card.removeEventListener('click', handleCardClick); 
                    card.style.cursor = 'default'; 
                });

                applyScoresAndProceed(); 
            }
        }

        function updateSelectionRanks() {
            selectionOrder.forEach((name, index) => {
                const cardElement = memberSelectionDiv.querySelector(`[data-name="${name}"]`);
                if (cardElement) {
                    cardElement.querySelector('.selection-rank').textContent = index + 1;
                }
            });
        }

        function applyScoresAndProceed() {
            if (gamePhase === 'tieBreakRound') {
                // 동점자 라운드 점수 부여
                memberData[selectionOrder[0]].score = parseFloat((memberData[selectionOrder[0]].score + 0.2).toFixed(2)); // 1순위: 0.2점
                memberData[selectionOrder[1]].score = parseFloat((memberData[selectionOrder[1]].score + 0.2).toFixed(2)); // 2순위: 0.2점
                memberData[selectionOrder[2]].score = parseFloat((memberData[selectionOrder[2]].score + 0.1).toFixed(2)); // 3순위: 0.1점 (선택 못 받은 것으로 간주)
                
                // 동점자 라운드에서는 3위 0점 탈락 로직 적용 안함
            } else {
                // 일반 라운드 점수 체계: 1위 3점, 2위 1점, 3위 0점
                memberData[selectionOrder[0]].score = parseFloat((memberData[selectionOrder[0]].score + 3).toFixed(2));   // 1순위: 3점
                memberData[selectionOrder[1]].score = parseFloat((memberData[selectionOrder[1]].score + 1).toFixed(2));   // 2순위: 1점
                // 3순위는 0점이므로 점수 추가 없음

                // 3순위 (0점) 받은 멤버의 횟수 증가 (initialSelection, finalSelection에만 해당)
                memberData[selectionOrder[2]].thirdPlaceCountForElimination++;
                // 3순위 (0점) 3회 받으면 해당 멤버 완전 제외
                if (memberData[selectionOrder[2]].thirdPlaceCountForElimination >= 3) {
                    memberData[selectionOrder[2]].eliminated = true;
                    console.log(`${selectionOrder[2]} 멤버가 3순위(0점) 3회로 제외되었습니다.`);
                }
            }


            document.querySelectorAll('.member-card').forEach(card => {
                card.classList.add('processed'); 
                card.classList.remove('selected'); 
                const rankSpan = card.querySelector('.selection-rank');
                if (rankSpan) rankSpan.textContent = ''; 
            });

            // 다음 라운드를 시작하거나, 게임 단계를 전환
            if (gamePhase === 'initialSelection') {
                const nonEliminatedMembersCount = memberNames.filter(name => !memberData[name].eliminated).length;
                if (nonEliminatedMembersCount <= 16) {
                    endInitialSelection(); 
                } else {
                    startNextRound();
                }
            } else if (gamePhase === 'finalSelection') {
                // 최종 선발 라운드는 더 이상 유효한 조합을 찾지 못할 때까지 계속 진행
                // getCandidateMembersForRound() 함수 내에서 이 조건을 처리하도록 변경됨
                startNextRound(); 
            } else if (gamePhase === 'tieBreakRound') {
                // 동점자 라운드 종료 후 다시 동점자 확인
                checkFinalResultsForTieBreaker();
            }
        }

        function endInitialSelection() {
            const sortedMembers = Object.entries(memberData)
                .filter(([, data]) => !data.eliminated) 
                .sort(([, a], [, b]) => b.score - a.score); 
            
            finalTop16Names = sortedMembers.slice(0, 16).map(member => member[0]);
            
            console.log("1차 선발 16인 확정:", finalTop16Names);

            startFinalRounds();
        }

        function startFinalRounds() {
            gamePhase = 'finalSelection';
            currentRound = 0; 
            playedCombinations = new Set(); 
            
            // 최종 16인 멤버의 점수만 초기화 (등장 횟수 및 3위 0점 횟수는 유지)
            // tieBreakRound 진입 시에는 등장 횟수를 재설정하지 않아야 함.
            // finalSelection으로 넘어올 때만 등장 횟수를 초기화
            finalTop16Names.forEach(name => {
                memberData[name].score = 0;
                memberData[name].appearances = 0; // 16인 멤버의 등장 횟수도 초기화하여 3회 제한을 다시 적용
            });
            // 16인에 들지 못한 멤버는 eliminated=true 유지되므로, 결선 라운드에 등장하지 않음

            updateInstructionText(); // 결선 라운드 안내 문구 업데이트
            
            startNextRound();
        }

        function checkFinalResultsForTieBreaker() {
            // 현재 finalTop16Names (최종 16인)을 기준으로 정렬
            const sortedFinalists = finalTop16Names
                .map(name => ({ name: name, score: memberData[name].score })) 
                .sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return a.name.localeCompare(b.name); // 점수 같으면 이름으로 정렬
                });

            // 동점자 그룹 찾기
            let tieGroups = [];
            let currentTieGroup = [];
            let prevScore = null;

            for (let i = 0; i < sortedFinalists.length; i++) {
                const member = sortedFinalists[i];
                if (prevScore === null || member.score === prevScore) {
                    currentTieGroup.push(member.name);
                } else {
                    // 이전 그룹이 동점자였고 (2명 이상), 2명 이상이어야 라운드 진행
                    if (currentTieGroup.length >= 2) { 
                        tieGroups.push(currentTieGroup);
                    }
                    currentTieGroup = [member.name];
                }
                prevScore = member.score;
            }
            // 마지막 그룹 처리
            if (currentTieGroup.length >= 2) {
                tieGroups.push(currentTieGroup);
            }
            
            if (tieGroups.length > 0) {
                // 동점자 라운드 시작
                console.log("동점자 그룹 발견:", tieGroups[0]);
                startTieBreakRound(tieGroups[0]); // 첫 번째 동점자 그룹으로 라운드 시작
            } else {
                // 동점자가 없으면 최종 결과 표시
                displayFinalResultsScreen(sortedFinalists);
            }
        }

        function startTieBreakRound(members) {
            gamePhase = 'tieBreakRound';
            currentRound = 0; // 동점자 라운드는 별도의 라운드 카운트
            playedCombinations = new Set(); // 동점자 라운드의 조합은 별도로 관리

            // 동점자 라운드에 참여할 멤버들
            tieBreakerMembers = members; 

            // 동점자 라운드 시작 시 모든 동점 멤버의 등장 횟수를 초기화하여 다시 3회 제한을 적용
            tieBreakerMembers.forEach(name => {
                memberData[name].appearances = 0; 
            });

            console.log("동점자 라운드 시작:", tieBreakerMembers);
            currentRoundSpan.textContent = "타이 브레이크"; // 라운드 표시 업데이트
            updateInstructionText(); // 동점자 라운드 안내 문구 업데이트
            startNextRound();
        }


        function displayFinalResultsScreen(sortedFinalists) {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            resetGameButton.style.display = 'none'; 
            instructionText.style.display = 'none'; 
            tieBreakerInfo.style.display = 'none'; // 동점자 안내 숨김

            resultsScreenTitle.textContent = '🎉 최종 선발 결과! 🎉';
            finalSelectionListTitle.textContent = '💖 최종 선발 16인 💖';

            const top3 = sortedFinalists.slice(0, 3); 

            topMembersDisplay.innerHTML = '';

            const topMembersOrderedForDisplay = [];
            let rank1Member = null;
            let rank2Member = null;
            let rank3Member = null;

            if (top3.length > 0) {
                rank1Member = top3[0];
            }
            if (top3.length > 1) {
                rank2Member = top3[1];
            }
            if (top3.length > 2) {
                rank3Member = top3[2];
            }

            // 2위 - 1위 - 3위 순서로 배열에 추가 (표시 순서)
            if (rank2Member) topMembersOrderedForDisplay.push(rank2Member);
            if (rank1Member) topMembersOrderedForDisplay.push(rank1Member);
            if (rank3Member) topMembersOrderedForDisplay.push(rank3Member);
            
            topMembersOrderedForDisplay.forEach((memberObj) => {
                const memberName = memberObj.name;
                const card = document.createElement('div');
                card.classList.add('top-member-card');
                let rankClass = '';
                // 실제 순위에 따라 클래스 부여 (원래 top3 배열의 순서를 따름)
                if (top3.length > 0 && memberName === top3[0].name) { 
                    rankClass = 'rank1';
                } else if (top3.length > 1 && memberName === top3[1].name) {
                    rankClass = 'rank2';
                } else if (top3.length > 2 && memberName === top3[2].name) {
                    rankClass = 'rank3';
                }
                card.classList.add(rankClass);

                card.innerHTML = `
                    <div class="rank-label">${rankClass.replace('rank','') + '위'}</div>
                    <img src="./images/${memberName}.png" alt="${memberName}">
                    <p>${memberName}</p>
                    <span class="score" style="display:none;">${memberObj.score.toFixed(2)}점</span> 
                `;
                topMembersDisplay.appendChild(card);
            });


            finalSelectionList.innerHTML = '';
            sortedFinalists.forEach((memberObj, index) => { 
                const listItem = document.createElement('li');
                listItem.textContent = `${index + 1}위. ${memberObj.name} (${memberObj.score.toFixed(2)}점)`; // 점수도 함께 표시
                finalSelectionList.appendChild(listItem);
            });
        }

        // 텍스트 결과 저장 기능
        function downloadTextResults() {
            const sortedFinalists = finalTop16Names
                .map(name => ({ name: name, score: memberData[name].score })) 
                .sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return a.name.localeCompare(b.name);
                }); 

            let resultText = "--- HKT48 최종 선발 16인 결과 ---\n\n";
            resultText += `총 진행 라운드 (결선): ${currentRound} 라운드\n\n`; 
            resultText += "🏆 최종 선발 16인 (순위 기준) 🏆\n";
            sortedFinalists.forEach((member, index) => {
                resultText += `${index + 1}위. ${member.name} (${member.score.toFixed(2)}점)\n`; 
            });
            resultText += "\n";

            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `HKT48_Senbatsu_Result_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 이미지 결과 저장 기능 (html2canvas 사용)
        async function downloadImageResults() {
            const resultsScreenElement = document.getElementById('resultsScreen');
            // 'restart-button-group'을 잠시 숨겨서 이미지에 포함되지 않도록 함
            const restartButtonGroup = resultsScreenElement.querySelector('.restart-button-group');
            restartButtonGroup.style.display = 'none'; 

            try {
                const canvas = await html2canvas(resultsScreenElement, {
                    scale: 2, 
                    useCORS: true 
                });
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `HKT48_Senbatsu_Result_${new Date().toISOString().slice(0,10)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("이미지 저장 실패:", error);
                alert("이미지 저장에 실패했습니다. 이미지가 로드되지 않았거나 문제가 발생했습니다. 브라우저 콘솔을 확인해주세요.");
            } finally {
                // 숨겼던 버튼 그룹 다시 표시
                restartButtonGroup.style.display = 'flex'; 
            }
        }

        // 화면 크기 변경 시 안내 문구 업데이트
        window.addEventListener('resize', updateInstructionText);

        document.addEventListener('DOMContentLoaded', () => {
            initializeGame();
        });
    </script>
</body>
</html>
