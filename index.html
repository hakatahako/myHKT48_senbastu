<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY HKT48 선발</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }
        /* 바닥판 */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            /* 멤버카드 폭 370px * 3개 + 카드 간 여백 15px * 2개 = 1110 + 30 = 1140px. 여유있게 1160px로 설정 */
            max-width: 1160px; 
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #ad1457;
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h2 {
            color: #7b1fa2;
            margin-top: 20px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .round-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            margin-bottom: 25px;
        }
        .member-display {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 15px; /* 멤버 카드 간격 15px */
            margin-top: 30px;
        }
        /* 멤버카드 (분홍색 판) */
        .member-card {
            background-color: #ffebee;
            border: 2px solid #ffccbc;
            border-radius: 15px;
            padding: 20px 10px; /* 상하 20px, 좌우 10px 여유 */
            width: 370px; /* 멤버사진 350px + 좌우 패딩 10px*2 = 370px */
            min-width: 370px; /* 카드가 더 이상 줄어들지 않도록 최소 너비 설정 */
            flex-shrink: 0; /* 부모 컨테이너가 작아져도 카드가 줄어들지 않게 함 */
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border-color: #ff8a65;
        }
        .member-card.selected {
            border: 4px solid #ad1457;
            background-color: #ffebf0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            transform: translateY(-8px) scale(1.02);
        }
        .member-card.processed {
            pointer-events: none;
            opacity: 0.8;
        }

        /* 멤버 사진 */
        .member-card img {
            width: 350px; /* 멤버 사진 크기 350px로 변경 */
            height: 350px; /* 멤버 사진 크기 350px로 변경 */
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        .member-card.selected img {
             /* 선택 시 이미지 테두리 색상 변경 없음 (테두리 자체가 없으니) */
        }
        .member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.3em;
            word-break: keep-all;
        }

        /* 순위 표시 스타일 */
        .selection-rank {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #ad1457;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .member-card.selected .selection-rank {
            opacity: 1;
        }

        .button-group {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        #startGameButton {
            background-color: #4CAF50;
            color: white;
            margin-top: 40px;
            position: relative;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #startGameButton:hover {
            background-color: #43A047;
        }
        #resetGameButton {
            background-color: #f44336;
            color: white;
            display: none;
            margin-top: 20px;
        }
        #resetGameButton:hover {
            background-color: #d32f2f;
        }

        /* 결과 화면 스타일 */
        .results-screen {
            display: none;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed #eee;
            text-align: left;
        }
        .results-screen h2 {
            text-align: center;
            color: #ad1457;
            font-size: 2.2em;
            margin-bottom: 30px;
        }
        .top-members {
            display: flex;
            justify-content: center; /* 가운데 정렬 */
            align-items: flex-end; /* 아래쪽으로 정렬하여 1위가 가운데 정렬된 채로 좌우 멤버보다 위로 올라오게 */
            gap: 20px; /* 간격 조정 */
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .top-member-card {
            background-color: #fdf3f7;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        /* 1위 카드 스타일 (2,3위보다 10% 더 크게) */
        .top-member-card.rank1 {
            /* 이미지 150px (2,3위) * 1.1 = 165px */
            width: calc(165px + 40px + 8px); /* 이미지 + 패딩 + 보더 = 약 213px */
            height: auto; 
            border: 4px solid #FFD700; 
            background-color: #FFFACD;
            transform: translateY(-20px); /* 1위 카드만 위로 살짝 올림 */
            order: 2; /* flex 순서: 1위가 가운데 오도록 */
        }
        .top-member-card.rank1 img {
            width: 165px; 
            height: 165px;
        }

        /* 2, 3위 카드 스타일 (기준 크기) */
        .top-member-card.rank2, .top-member-card.rank3 {
            width: calc(150px + 40px + 8px); /* 이미지 + 패딩 + 보더 = 약 198px */
            height: auto; 
            border: 4px solid #C0C0C0; 
            background-color: #E0E0E0;
            order: 1; /* 2위가 왼쪽 */
        }
        .top-member-card.rank3 {
            border: 4px solid #CD7F32; 
            background-color: #D2B48C;
            order: 3; /* 3위가 오른쪽 */
        }
        .top-member-card.rank2 img, .top-member-card.rank3 img {
            width: 150px; 
            height: 150px;
        }
        
        .top-member-card img {
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            /* 테두리 제거 */
        }
        .top-member-card p {
            margin: 0;
            font-weight: bold;
            color: #ad1457;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        .top-member-card .score {
            font-size: 1.2em;
            color: #555;
            font-weight: normal;
            display: none; /* 최종 3인 카드에서도 점수 숨김 */
        }
        .rank-label {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ad1457;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rank1 .rank-label { background-color: #FFD700; color: #333; }
        .rank2 .rank-label { background-color: #C0C0C0; color: #333; }
        .rank3 .rank-label { background-color: #CD7F32; color: white; }

        .final-selection-list {
            margin-top: 30px;
            text-align: center;
            font-size: 1.1em;
            color: #555;
        }
        .final-selection-list h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        .final-selection-list ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }
        .final-selection-list li {
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #bbdefb;
            font-weight: bold;
            color: #2196F3;
        }
        .restart-button-group {
            margin-top: 40px;
            text-align: center;
            display: flex;
            flex-direction: column; /* 버튼들을 세로로 정렬 */
            align-items: center;
            gap: 15px; /* 버튼 간격 */
        }
        .restart-button-group button {
            width: 250px; /* 버튼 너비 통일 */
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                max-width: 95%; /* 모바일에서는 화면 너비에 맞춰 유동적으로 */
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.5em;
            }
            .member-display {
                flex-direction: column; /* 모바일에서는 세로로 쌓이게 */
                align-items: center;
                gap: 15px;
            }
            .member-card {
                width: 280px; /* 모바일에서 카드 너비 조정 (사진 250px + 패딩 10px*2) */
                min-width: 280px; 
                padding: 10px;
            }
            .member-card img {
                width: 250px; /* 모바일에서는 이미지 크기 조정 */
                height: 250px;
            }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 90%;
                padding: 12px 20px;
                font-size: 1.1em;
            }
            .top-members {
                flex-direction: column; /* 모바일에서는 다시 세로로 */
                align-items: center;
                gap: 20px;
            }
            .top-member-card {
                width: 90%; /* 모바일에서 카드 너비 */
                transform: none !important; /* 모바일에서는 transform 제거 */
                order: initial !important; /* 모바일에서는 order 초기화 */
            }
            .top-member-card.rank1 img {
                width: 150px; 
                height: 150px;
            }
            .top-member-card.rank2 img, .top-member-card.rank3 img {
                width: 120px;
                height: 120px;
            }
            #startGameButton {
                position: static;
                transform: none;
                width: 90%;
                margin: 20px auto;
            }
            .restart-button-group button { 
                width: 90%; /* 모바일에서 재시작 버튼 너비 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MY HKT48 선발</h1>
        <p>당신의 선택으로 HKT48 <b>16인 선발 멤버</b>를 뽑아주세요!</p>
        <p id="instructionText" style="font-weight: bold; color: #ad1457;"></p>

        <div id="gameScreen">
            <div class="round-info">
                <span id="currentRound"></span> 라운드
            </div>
            <h2>오늘의 멤버를 선택하세요!</h2>
            <div class="member-display" id="memberSelection">
                </div>
            <div class="button-group">
                <button id="resetGameButton">게임 초기화</button>
            </div>
        </div>

        <button id="startGameButton">게임 시작</button>

        <div id="resultsScreen" class="results-screen">
            <h2 id="resultsScreenTitle">🎉 최종 선발 결과! 🎉</h2>
            <div class="top-members" id="topMembersDisplay">
                </div>
            <div class="final-selection-list">
                <h3 id="finalSelectionListTitle">💖 최종 선발 16인 💖</h3>
                <ul id="finalSelectionList">
                    </ul>
            </div>
            <div class="restart-button-group">
                <button id="downloadTextResultButton">결과 저장 (텍스트)</button>
                <button id="downloadImageResultButton">결과 저장 (이미지)</button>
                <button id="restartGameButton">새 게임 시작</button>
            </div>
        </div>
    </div>

    <script>
        const memberNames = [
            "나가노 라라", "나카노 미나미", "다나카 이오리", "류토 아야네", "마츠나가 유이", "마츠모토 모카",
            "모리사키 사아야", "사카모토 리노", "시부이 미나", "아오키 히나코", "아키요시 유카","야나세 레이아","야마우치 유나","야마카와 마리아",
            "야스이 히나", "에구치 코코하", "에우라 유카", "오오바 리사키", "오오우치 린카", "요시다 메이", "이마무라 마리아", "이시마츠 유이나",
            "이시바시 이부키", "이시이 아야네", "이시카와 아미유", "이시하라 한나", "이자와 미유", "이지마 리리아", "이치무라 아이리", "이쿠노 리나",
            "지토우에 네네", 
            "츠루카와 나치", "츠츠미 후카", "카타히라 사라", "쿠레 유나", "쿠리야마 리나", "쿠리하라 사에", "키타가와 히이로",
            "타치바나 코코로", "타케모토 쿠루미", "토요나가 아키", "후지노 코코하", "후쿠이 카렌"
        ];

        let memberData = {}; 
        let currentRound = 0;
        const membersPerRound = 3;
        let selectionOrder = [];
        let playedCombinations = new Set(); 
        let gamePhase = 'initialSelection'; // 'initialSelection', 'finalSelection'
        let finalTop16Names = []; // 1차 선발에서 뽑힌 16인의 이름만 저장

        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const currentRoundSpan = document.getElementById('currentRound');
        const memberSelectionDiv = document.getElementById('memberSelection');
        const startGameButton = document.getElementById('startGameButton');
        const resetGameButton = document.getElementById('resetGameButton');
        const topMembersDisplay = document.getElementById('topMembersDisplay');
        const finalSelectionList = document.getElementById('finalSelectionList');
        const restartGameButton = document.getElementById('restartGameButton');
        const downloadTextResultButton = document.getElementById('downloadTextResultButton'); 
        const downloadImageResultButton = document.getElementById('downloadImageResultButton'); 
        const instructionText = document.getElementById('instructionText');
        const resultsScreenTitle = document.getElementById('resultsScreenTitle');
        const finalSelectionListTitle = document.getElementById('finalSelectionListTitle');


        startGameButton.addEventListener('click', initializeGame);
        resetGameButton.addEventListener('click', initializeGame);
        restartGameButton.addEventListener('click', initializeGame);
        downloadTextResultButton.addEventListener('click', downloadTextResults); 
        downloadImageResultButton.addEventListener('click', downloadImageResults); 

        function initializeGame() {
            // 모든 멤버 데이터 초기화
            memberData = {}; 
            for (const name of memberNames) {
                memberData[name] = { score: 0, appearances: 0, thirdPlaceCount: 0, eliminated: false };
            }
            currentRound = 0;
            playedCombinations = new Set(); 
            gamePhase = 'initialSelection'; // 1차 선발 단계로 설정
            finalTop16Names = []; // 16인 멤버 초기화

            gameScreen.style.display = 'block';
            resultsScreen.style.display = 'none';
            startGameButton.style.display = 'none';
            resetGameButton.style.display = 'block';
            instructionText.style.display = 'block'; 

            instructionText.textContent = '3인의 멤버를 좋아하는 순서대로 선택해주세요. 1,2위가 결정되면 3위는 자동선택됩니다.';

            startNextRound();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; 
            }
            return array;
        }

        function getCandidateMembersForRound() {
            let candidates = [];
            if (gamePhase === 'initialSelection') {
                candidates = memberNames.filter(name => memberData[name].appearances < 3 && !memberData[name].eliminated);
                
                // 1차 선발 시 현재 잔류 멤버 수 확인
                const nonEliminatedMembers = memberNames.filter(name => !memberData[name].eliminated);
                // 잔류 멤버가 16명 이하가 되면 1차 선발 종료
                if (nonEliminatedMembers.length <= 16 && currentRound > 0) { // 최소 1라운드 이상 진행 후
                    console.log(`잔류 멤버가 ${nonEliminatedMembers.length}명 이므로 1차 선발을 종료합니다.`);
                    endInitialSelection(); 
                    return []; 
                }

            } else if (gamePhase === 'finalSelection') {
                candidates = finalTop16Names.filter(name => memberData[name].appearances < 3); // 결선에서는 탈락 없음
            }
            
            // 더 이상 등장시킬 멤버가 없으면 결과 표시 (어떤 단계든)
            if (candidates.length < membersPerRound) {
                console.log(`다음 라운드에 등장할 멤버 후보가 부족합니다. 현재 단계: ${gamePhase}`);
                if (gamePhase === 'initialSelection') {
                    // 이 경우는 사실상 발생하지 않음 (16인 이하 되면 endInitialSelection에서 처리)
                    endInitialSelection(); 
                } else { // finalSelection 단계
                    displayFinalResults(); 
                }
                return [];
            }
            
            let roundMembers = [];
            let attempts = 0;
            const maxAttempts = 20000; 

            while (roundMembers.length < membersPerRound && attempts < maxAttempts) {
                const tempShuffle = shuffleArray([...candidates]);
                const potentialRound = tempShuffle.slice(0, membersPerRound);
                
                // 같은 조합 방지 및 3회 등장 제한 (최종 선발에서도 적용)
                const isValidCombination = potentialRound.every(name => memberData[name].appearances < 3);
                const combinationKey = [...potentialRound].sort().join('-');

                if (isValidCombination && !playedCombinations.has(combinationKey)) {
                    roundMembers = potentialRound;
                    playedCombinations.add(combinationKey);
                }
                attempts++;
            }

            // 충분한 시도 후에도 조합을 찾지 못하면, 등장 횟수가 가장 적은 멤버 우선으로 강제 선택
            if (roundMembers.length < membersPerRound) {
                console.warn("경고: 엄격한 규칙(3회 등장 제한, 같은 3인 조합 2번 나오지 않음)을 준수하며 멤버를 찾기 어려워 강제로 선택합니다.");
                const sortedCandidates = candidates.sort((a, b) => memberData[a].appearances - memberData[b].appearances);
                roundMembers = sortedCandidates.slice(0, membersPerRound);
                playedCombinations.add([...roundMembers].sort().join('-'));
            }
            return roundMembers;
        }

        function startNextRound() {
            currentRound++;
            currentRoundSpan.textContent = currentRound;
            selectionOrder = []; 

            const membersForThisRound = getCandidateMembersForRound(); // getUniqueRoundMembers -> getCandidateMembersForRound 로 변경
            if (membersForThisRound.length === 0) { 
                return; 
            }

            const shuffledMembersForDisplay = shuffleArray(membersForThisRound); 

            memberSelectionDiv.innerHTML = ''; 
            shuffledMembersForDisplay.forEach(name => {
                const card = document.createElement('div');
                card.classList.add('member-card');
                card.dataset.name = name;
                card.innerHTML = `
                    <div class="selection-rank"></div>
                    <img src="./images/${name}.png" alt="${name}">
                    <p>${name}</p>
                `;
                card.addEventListener('click', () => handleCardClick(card, name));
                memberSelectionDiv.appendChild(card);

                // appearance 카운트는 라운드 시작 시에만 증가
                // 단, 최종 선발 단계에서는 appearances가 0으로 초기화되지 않으므로, 이 시점에서 증가시키는 것은 
                // 전체 등장 횟수(3회 제한)를 유지하는 데 도움이 됩니다.
                // 이미 3회 이상 등장한 멤버는 getCandidateMembersForRound에서 걸러지므로 문제 없음.
                memberData[name].appearances++; 
            });
        }

        function handleCardClick(clickedCard, memberName) {
            const isAlreadySelected = selectionOrder.includes(memberName);

            if (isAlreadySelected) {
                if (selectionOrder[selectionOrder.length - 1] === memberName) {
                    clickedCard.classList.remove('selected');
                    const rankSpan = clickedCard.querySelector('.selection-rank');
                    if (rankSpan) rankSpan.textContent = ''; 
                    selectionOrder.pop(); 
                    
                    updateSelectionRanks();
                } else {
                    alert("선택은 가장 마지막에 클릭한 멤버부터 해제할 수 있습니다.");
                }
            } else {
                if (selectionOrder.length < 2) { 
                    clickedCard.classList.add('selected');
                    selectionOrder.push(memberName);
                    const rankSpan = clickedCard.querySelector('.selection-rank');
                    if (rankSpan) rankSpan.textContent = selectionOrder.length; 
                } else {
                    alert("1위와 2위 두 명의 멤버를 선택했습니다. 3위는 자동으로 결정됩니다.");
                    return;
                }
            }

            if (selectionOrder.length === 2) {
                const allCurrentCards = Array.from(memberSelectionDiv.querySelectorAll('.member-card'));
                const selectedNamesInRound = selectionOrder;
                const thirdPlaceCard = allCurrentCards.find(card => !selectedNamesInRound.includes(card.dataset.name));
                
                if (thirdPlaceCard) {
                    const thirdPlaceName = thirdPlaceCard.dataset.name;
                    selectionOrder.push(thirdPlaceName); 
                }

                document.querySelectorAll('.member-card').forEach(card => {
                    card.removeEventListener('click', handleCardClick); 
                    card.style.cursor = 'default'; 
                });

                applyScoresAndProceed(); 
            }
        }

        function updateSelectionRanks() {
            selectionOrder.forEach((name, index) => {
                const cardElement = memberSelectionDiv.querySelector(`[data-name="${name}"]`);
                if (cardElement) {
                    cardElement.querySelector('.selection-rank').textContent = index + 1;
                }
            });
        }

        function applyScoresAndProceed() {
            memberData[selectionOrder[0]].score += 3;
            memberData[selectionOrder[1]].score += 2;
            memberData[selectionOrder[2]].score += 1; 

            memberData[selectionOrder[2]].thirdPlaceCount++;
            // 1차 선발에서만 3위 3회 탈락 규칙 적용
            if (memberData[selectionOrder[2]].thirdPlaceCount >= 3 && gamePhase === 'initialSelection') {
                memberData[selectionOrder[2]].eliminated = true;
                console.log(`${selectionOrder[2]} 멤버가 3위 3회로 탈락했습니다.`);
            }

            document.querySelectorAll('.member-card').forEach(card => {
                card.classList.add('processed'); 
                card.classList.remove('selected'); 
                const rankSpan = card.querySelector('.selection-rank');
                if (rankSpan) rankSpan.textContent = ''; 
            });

            // 다음 라운드를 시작하거나, 게임 단계를 전환
            if (gamePhase === 'initialSelection') {
                const nonEliminatedMembersCount = memberNames.filter(name => !memberData[name].eliminated).length;
                if (nonEliminatedMembersCount <= 16) {
                    endInitialSelection(); // 16인 선발 확정 및 최종 라운드 시작
                } else {
                    startNextRound();
                }
            } else if (gamePhase === 'finalSelection') {
                // 최종 선발 라운드 종료 조건: 모든 16인 멤버가 각각 3회씩 등장했거나, 충분한 라운드가 진행되었을 때
                // 이 예시에서는 11라운드 이상 진행 시 종료 (충분한 점수 분배를 위해)
                // 또는 특정 멤버의 점수 차이가 충분히 벌어졌을 때 종료하는 로직도 가능
                if (currentRound >= 11) { // 이 부분을 조절하여 라운드 수 결정
                    displayFinalResults();
                } else {
                    startNextRound();
                }
            }
        }

        function endInitialSelection() {
            // 1차 선발이 끝났을 때 16인을 확정
            const sortedMembers = Object.entries(memberData)
                .filter(([, data]) => !data.eliminated) // 탈락하지 않은 멤버만
                .sort(([, a], [, b]) => b.score - a.score); // 점수 높은 순 정렬
            
            finalTop16Names = sortedMembers.slice(0, 16).map(member => member[0]);
            
            console.log("1차 선발 16인 확정:", finalTop16Names);

            // 최종 선발 라운드 시작
            startFinalRounds();
        }

        function startFinalRounds() {
            gamePhase = 'finalSelection';
            currentRound = 0; // 결선 라운드부터 다시 라운드 카운트 시작
            playedCombinations = new Set(); // 조합 초기화
            
            // 최종 16인 멤버의 점수만 초기화 (등장 횟수는 유지하여 3회 등장 제한 규칙 적용)
            for (const name of finalTop16Names) {
                memberData[name].score = 0; // 점수 초기화
            }
            // 16인에 들지 못한 멤버는 eliminated=true 유지되므로, 결선 라운드에 등장하지 않음

            instructionText.textContent = '선발된 16명 중 최종 순위를 결정합니다. 3인의 멤버를 좋아하는 순서대로 선택해주세요.';
            
            startNextRound();
        }

        function displayFinalResults() {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
            resetGameButton.style.display = 'none'; 
            instructionText.style.display = 'none'; 

            resultsScreenTitle.textContent = '🎉 최종 선발 결과! 🎉';
            finalSelectionListTitle.textContent = '💖 최종 선발 16인 💖';

            const sortedFinalists = finalTop16Names
                .map(name => ({ name: name, score: memberData[name].score })) // 이름과 결선 점수 포함
                .sort((a, b) => b.score - a.score); 

            const top3 = sortedFinalists.slice(0, 3); 

            topMembersDisplay.innerHTML = '';

            const topMembersOrderedForDisplay = [];
            let rank1Member = null;
            let rank2Member = null;
            let rank3Member = null;

            if (top3.length > 0) {
                rank1Member = top3[0];
            }
            if (top3.length > 1) {
                rank2Member = top3[1];
            }
            if (top3.length > 2) {
                rank3Member = top3[2];
            }

            // 2위 - 1위 - 3위 순서로 배열에 추가 (표시 순서)
            if (rank2Member) topMembersOrderedForDisplay.push(rank2Member);
            if (rank1Member) topMembersOrderedForDisplay.push(rank1Member);
            if (rank3Member) topMembersOrderedForDisplay.push(rank3Member);
            
            topMembersOrderedForDisplay.forEach((memberObj) => {
                const memberName = memberObj.name;
                const card = document.createElement('div');
                card.classList.add('top-member-card');
                let rankClass = '';
                // 실제 순위에 따라 클래스 부여 (원래 top3 배열의 순서를 따름)
                if (memberName === top3[0].name) { 
                    rankClass = 'rank1';
                } else if (top3.length > 1 && memberName === top3[1].name) {
                    rankClass = 'rank2';
                } else if (top3.length > 2 && memberName === top3[2].name) {
                    rankClass = 'rank3';
                }
                card.classList.add(rankClass);

                card.innerHTML = `
                    <div class="rank-label">${rankClass.replace('rank','') + '위'}</div>
                    <img src="./images/${memberName}.png" alt="${memberName}">
                    <p>${memberName}</p>
                    <span class="score" style="display:none;">${memberObj.score}점</span> `;
                topMembersDisplay.appendChild(card);
            });


            finalSelectionList.innerHTML = '';
            sortedFinalists.forEach((memberObj, index) => { 
                const listItem = document.createElement('li');
                listItem.textContent = `${index + 1}위. ${memberObj.name}`;
                finalSelectionList.appendChild(listItem);
            });
        }

        // 텍스트 결과 저장 기능
        function downloadTextResults() {
            const sortedFinalists = finalTop16Names
                .map(name => ({ name: name, score: memberData[name].score })) 
                .sort((a, b) => b.score - a.score); 

            let resultText = "--- HKT48 최종 선발 16인 결과 ---\n\n";
            resultText += `총 진행 라운드 (1차 선발 및 결선 포함): ${currentRound} 라운드\n\n`; 
            resultText += "🏆 최종 선발 16인 (순위 기준) 🏆\n";
            sortedFinalists.forEach((member, index) => {
                resultText += `${index + 1}위. ${member.name}\n`; // 점수 제거
            });
            resultText += "\n";

            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `HKT48_Senbatsu_Result_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 이미지 결과 저장 기능 (html2canvas 사용)
        async function downloadImageResults() {
            const resultsScreenElement = document.getElementById('resultsScreen');
            // 'restart-button-group'을 잠시 숨겨서 이미지에 포함되지 않도록 함
            const restartButtonGroup = resultsScreenElement.querySelector('.restart-button-group');
            restartButtonGroup.style.display = 'none'; 

            try {
                const canvas = await html2canvas(resultsScreenElement, {
                    scale: 2, 
                    useCORS: true 
                });
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `HKT48_Senbatsu_Result_${new Date().toISOString().slice(0,10)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("이미지 저장 실패:", error);
                alert("이미지 저장에 실패했습니다. 이미지가 로드되지 않았거나 문제가 발생했습니다. 브라우저 콘솔을 확인해주세요.");
            } finally {
                // 숨겼던 버튼 그룹 다시 표시
                restartButtonGroup.style.display = 'flex'; 
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
            startGameButton.style.display = 'block';
            resetGameButton.style.display = 'none';
            instructionText.style.display = 'block'; 
            instructionText.textContent = '게임을 시작하려면 "게임 시작" 버튼을 눌러주세요.';
        });
    </script>
</body>
</html>
